generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(cuid())
  name         String
  mobile       String?  @unique
  email        String?  @unique
  passwordHash String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Legacy fields for backward compatibility
  emailVerified            DateTime?
  password                 String?
  image                    String?
  firstName                String?
  lastName                 String?
  phone                    String?
  avatar                   String?
  role                     UserRole               @default(STUDENT)
  active                   Boolean                @default(true)
  twoFactorEnabled         Boolean                @default(false)
  twoFactorSecret          String?
  twoFactorBackupCodes     String?
  lastLoginAt              DateTime?
  mfaEnabled               Boolean                @default(false)
  mfaSecret                String?
  permissions              Json?
  accounts                 Account[]
  administrator            Administrator?
  documents                Document[]
  eventRSVPs               EventRSVP[]
  receivedMessages         Message[]              @relation("ReceivedMessages")
  sentMessages             Message[]              @relation("SentMessages")
  notifications            Notification[]
  parent                   Parent?
  sessions                 Session[]
  authSessions             AuthSession[]          @relation("AuthSessions")
  student                  Student?
  teacher                  Teacher?
  analyticsEvents          AnalyticsEvent[]
  auditLogs                AuditLog[]
  complianceReports        ComplianceReport[]
  kbArticles               KnowledgeBaseArticle[]
  messageHistory           MessageHistory[]       @relation("MessageHistorySentBy")
  savedReports             SavedReportConfig[]
  assignedTickets          SupportTicket[]        @relation("AssignedTickets")
  createdTickets           SupportTicket[]        @relation("CreatedTickets")
  ticketComments           TicketComment[]
  userPermissions          UserPermission[]
  userSchools              UserSchool[]
  resolvedAlerts           Alert[]
  createdAlertConfigs      AlertConfig[]
  performedEmergencyAccess EmergencyAccess[]      @relation("EmergencyAccessPerformedBy")
  reversedEmergencyAccess  EmergencyAccess[]      @relation("EmergencyAccessReversedBy")
}

model School {
  id                      String                        @id @default(cuid())
  name                    String
  schoolCode              String                        @unique
  phone                   String?
  email                   String?
  address                 String?
  domain                  String?
  subdomain               String?                       @unique
  subdomainStatus         SubdomainStatus               @default(PENDING)
  dnsConfigured           Boolean                       @default(false)
  sslConfigured           Boolean                       @default(false)
  sslExpiresAt            DateTime?
  plan                    PlanType                      @default(STARTER)
  status                  SchoolStatus                  @default(ACTIVE)
  isOnboarded             Boolean                       @default(false)
  onboardingStep          Int                           @default(0)
  onboardingCompletedAt   DateTime?
  tagline                 String?
  logo                    String?
  favicon                 String?
  primaryColor            String                        @default("#3b82f6")
  secondaryColor          String                        @default("#8b5cf6")
  metadata                Json?
  razorpayCustomerId      String?                       @unique
  createdAt               DateTime                      @default(now())
  updatedAt               DateTime                      @updatedAt
  academicYears           AcademicYear[]
  Achievement             Achievement[]
  administrators          Administrator[]
  AdmissionApplication    AdmissionApplication[]
  Announcement            Announcement[]
  ApplicationDocument     ApplicationDocument[]
  AssessmentRule          AssessmentRule[]
  Assignment              Assignment[]
  AssignmentClass         AssignmentClass[]
  AssignmentSubmission    AssignmentSubmission[]
  Backup                  Backup[]
  Book                    Book[]
  BookIssue               BookIssue[]
  BookReservation         BookReservation[]
  Budget                  Budget[]
  classes                 Class[]
  ClassEnrollment         ClassEnrollment[]
  ClassRoom               ClassRoom[]
  classSections           ClassSection[]
  ClassTeacher            ClassTeacher[]
  Department              Department[]
  Document                Document[]
  DocumentType            DocumentType[]
  Event                   Event[]
  EventParticipant        EventParticipant[]
  EventRSVP               EventRSVP[]
  Exam                    Exam[]
  ExamResult              ExamResult[]
  ExamType                ExamType[]
  Expense                 Expense[]
  FeePayment              FeePayment[]
  FeeStructure            FeeStructure[]
  FeeStructureClass       FeeStructureClass[]
  FeeStructureItem        FeeStructureItem[]
  FeeType                 FeeType[]
  FeeTypeClassAmount      FeeTypeClassAmount[]
  GradeScale              GradeScale[]
  LeaveApplication        LeaveApplication[]
  Lesson                  Lesson[]
  MeritList               MeritList[]
  MeritListConfig         MeritListConfig[]
  MeritListEntry          MeritListEntry[]
  Message                 Message[]
  Module                  Module[]
  Notification            Notification[]
  parents                 Parent[]
  ParentMeeting           ParentMeeting[]
  ParentSettings          ParentSettings[]
  Payroll                 Payroll[]
  ReportCard              ReportCard[]
  SalaryStructure         SalaryStructure[]
  Scholarship             Scholarship[]
  ScholarshipRecipient    ScholarshipRecipient[]
  students                Student[]
  studentAttendances      StudentAttendance[]
  StudentParent           StudentParent[]
  StudentSettings         StudentSettings[]
  SubModule               SubModule[]
  SubModuleProgress       SubModuleProgress[]
  Subject                 Subject[]
  SubjectClass            SubjectClass[]
  SubjectGroup            SubjectGroup[]
  SubjectGroupMapping     SubjectGroupMapping[]
  SubjectTeacher          SubjectTeacher[]
  SubjectVariant          SubjectVariant[]
  Syllabus                Syllabus[]
  SyllabusDocument        SyllabusDocument[]
  SyllabusUnit            SyllabusUnit[]
  teachers                Teacher[]
  TeacherAttendance       TeacherAttendance[]
  TeacherSettings         TeacherSettings[]
  terms                   Term[]
  Timetable               Timetable[]
  TimetableConfig         TimetableConfig[]
  TimetablePeriod         TimetablePeriod[]
  TimetableSlot           TimetableSlot[]
  Alumni                  Alumni[]
  analyticsEvents         AnalyticsEvent[]
  eventCategories         CalendarEventCategory[]
  calendarEvents          CalendarEvent[]
  CertificateTemplate     CertificateTemplate[]
  CoScholasticActivity    CoScholasticActivity[]
  CoScholasticGrade       CoScholasticGrade[]
  CommunicationErrorLog   CommunicationErrorLog[]
  CourseContent           CourseContent[]
  CourseDiscussion        CourseDiscussion[]
  CourseEnrollment        CourseEnrollment[]
  CourseLesson            CourseLesson[]
  CourseModule            CourseModule[]
  Course                  Course[]
  DiscussionReply         DiscussionReply[]
  Driver                  Driver[]
  enhancedSubscriptions   EnhancedSubscription[]
  EventNote               EventNote[]
  EventReminder           EventReminder[]
  ExamAttempt             ExamAttempt[]
  GeneratedCertificate    GeneratedCertificate[]
  HostelComplaint         HostelComplaint[]
  HostelFeePayment        HostelFeePayment[]
  HostelRoomAllocation    HostelRoomAllocation[]
  HostelRoom              HostelRoom[]
  HostelVisitor           HostelVisitor[]
  Hostel                  Hostel[]
  LessonProgress          LessonProgress[]
  LessonQuiz              LessonQuiz[]
  MessageHistory          MessageHistory[]
  MessageLog              MessageLog[]
  MessageTemplate         MessageTemplate[]
  OnlineExam              OnlineExam[]
  PaymentReceipt          PaymentReceipt[]
  PromotionHistory        PromotionHistory[]
  PromotionRecord         PromotionRecord[]
  QuestionBank            QuestionBank[]
  QuizAttempt             QuizAttempt[]
  ReceiptNote             ReceiptNote[]
  ReportCardTemplate      ReportCardTemplate[]
  RouteStop               RouteStop[]
  Route                   Route[]
  SavedReportConfig       SavedReportConfig[]
  ScheduledReport         ScheduledReport[]
  StudentRoute            StudentRoute[]
  SubjectMarkConfig       SubjectMarkConfig[]
  subscriptions           Subscription[]
  supportTickets          SupportTicket[]
  TransportAttendance     TransportAttendance[]
  usageCounters           UsageCounter[]
  UserCalendarPreferences UserCalendarPreferences[]
  userSchools             UserSchool[]
  Vehicle                 Vehicle[]
  paymentMethods          PaymentMethodRecord[]
  systemMetrics           SystemMetric[]
  alerts                  Alert[]
  alertConfigs            AlertConfig[]
  auditLogs               AuditLog[]
  permissions             SchoolPermissions?
  settings                SchoolSettings?
  studentAchievements     StudentAchievement[]
  studentXPLevels         StudentXPLevel[]
  studentNotes            StudentNote[]
  flashcardDecks          FlashcardDeck[]
  flashcards              Flashcard[]
  mindMaps                MindMap[]
  lessonContents          LessonContent[]
  studentContentProgress  StudentContentProgress[]

  @@map("schools")
}

model Subscription {
  id            String   @id @default(cuid())
  schoolId      String
  billingCycle  String   @default("MONTHLY")
  startDate     DateTime @default(now())
  endDate       DateTime
  isActive      Boolean  @default(true)
  paymentStatus String   @default("PAID")
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  school        School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@map("subscriptions")
}

model SubscriptionPlan {
  id             String                 @id @default(cuid())
  name           String
  description    String?
  razorpayPlanId String?                @unique
  amount         Int
  currency       String                 @default("inr")
  interval       String
  features       Json
  isActive       Boolean                @default(true)
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt
  subscriptions  EnhancedSubscription[]

  @@map("subscription_plans")
}

model EnhancedSubscription {
  id                     String             @id @default(cuid())
  schoolId               String
  razorpaySubscriptionId String?            @unique
  planId                 String
  status                 SubscriptionStatus
  currentPeriodStart     DateTime
  currentPeriodEnd       DateTime
  cancelAtPeriodEnd      Boolean            @default(false)
  trialEnd               DateTime?
  metadata               Json?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  plan                   SubscriptionPlan   @relation(fields: [planId], references: [id])
  school                 School             @relation(fields: [schoolId], references: [id])
  invoices               Invoice[]
  payments               Payment[]

  @@map("enhanced_subscriptions")
}

model Invoice {
  id                String               @id @default(cuid())
  subscriptionId    String
  razorpayInvoiceId String?              @unique
  amount            Int
  currency          String               @default("inr")
  status            InvoiceStatus
  dueDate           DateTime
  paidAt            DateTime?
  metadata          Json?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  subscription      EnhancedSubscription @relation(fields: [subscriptionId], references: [id])
  payments          Payment[]

  @@map("invoices")
}

model Payment {
  id                String               @id @default(cuid())
  subscriptionId    String
  invoiceId         String?
  razorpayPaymentId String?              @unique
  amount            Int
  currency          String               @default("inr")
  status            PaymentStatus
  paymentMethod     String?
  failureReason     String?
  processedAt       DateTime?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  invoice           Invoice?             @relation(fields: [invoiceId], references: [id])
  subscription      EnhancedSubscription @relation(fields: [subscriptionId], references: [id])

  @@map("payments")
}

model PaymentMethodRecord {
  id                 String   @id @default(cuid())
  schoolId           String
  razorpayCustomerId String?
  type               String // card, netbanking, wallet, upi
  encryptedDetails   String // encrypted payment details
  last4              String?
  brand              String?
  expiryMonth        String?
  expiryYear         String?
  holderName         String?
  isDefault          Boolean  @default(false)
  isActive           Boolean  @default(true)
  metadata           Json?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  school             School   @relation(fields: [schoolId], references: [id])

  @@map("payment_method_records")
}

model UsageCounter {
  id             String   @id @default(cuid())
  schoolId       String
  month          String
  whatsappUsed   Int      @default(0)
  smsUsed        Int      @default(0)
  whatsappLimit  Int      @default(1000)
  smsLimit       Int      @default(1000)
  storageUsedMB  Float    @default(0)
  storageLimitMB Int      @default(1024)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  school         School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, month])
  @@index([schoolId])
  @@map("usage_counters")
}

model UserSchool {
  id        String   @id @default(cuid())
  userId    String
  schoolId  String
  role      UserRole @default(STUDENT)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, schoolId])
  @@index([userId])
  @@index([schoolId])
  @@index([role])
  @@map("user_schools")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model OTP {
  id         String   @id @default(cuid())
  identifier String // mobile or email
  codeHash   String
  expiresAt  DateTime
  attempts   Int      @default(0)
  isUsed     Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([identifier])
  @@index([expiresAt])
  @@map("otps")
}

model AuthSession {
  id             String   @id @default(cuid())
  userId         String
  token          String   @unique
  activeSchoolId String?
  expiresAt      DateTime
  createdAt      DateTime @default(now())
  lastAccessAt   DateTime @default(now())

  user User @relation("AuthSessions", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("auth_sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Administrator {
  id            String         @id @default(cuid())
  userId        String         @unique
  position      String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  schoolId      String
  school        School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  announcements Announcement[]

  @@index([schoolId])
}

model Teacher {
  id                String              @id @default(cuid())
  userId            String              @unique
  employeeId        String              @unique
  qualification     String?
  joinDate          DateTime
  salary            Float?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  schoolId          String
  achievements      Achievement[]
  assignmentCreated Assignment[]
  classes           ClassTeacher[]
  examCreated       Exam[]
  parentMeetings    ParentMeeting[]
  payrolls          Payroll[]
  salaryStructure   SalaryStructure?
  subjects          SubjectTeacher[]
  school            School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user              User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  attendance        TeacherAttendance[]
  settings          TeacherSettings?
  courses           Course[]
  onlineExams       OnlineExam[]
  questionBanks     QuestionBank[]
  departments       Department[]        @relation("DepartmentTeachers")

  @@index([schoolId])
}

model TeacherSettings {
  id                        String   @id @default(cuid())
  teacherId                 String   @unique
  emailNotifications        Boolean  @default(true)
  smsNotifications          Boolean  @default(false)
  pushNotifications         Boolean  @default(true)
  assignmentReminders       Boolean  @default(true)
  examReminders             Boolean  @default(true)
  messageNotifications      Boolean  @default(true)
  announcementNotifications Boolean  @default(true)
  theme                     String   @default("LIGHT")
  colorTheme                String   @default("blue")
  language                  String   @default("en")
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  schoolId                  String
  school                    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teacher                   Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([teacherId])
  @@index([schoolId])
}

model Student {
  id                    String                   @id @default(cuid())
  userId                String                   @unique
  admissionId           String                   @unique
  admissionDate         DateTime
  rollNumber            String?
  dateOfBirth           DateTime
  gender                String
  address               String?
  bloodGroup            String?
  height                Float?
  weight                Float?
  emergencyContact      String?
  aadhaarNumber         String?                  @db.VarChar(12)
  apaarId               String?                  @db.VarChar(50)
  pen                   String?                  @db.VarChar(50)
  abcId                 String?                  @db.VarChar(50)
  nationality           String?                  @default("Indian")
  religion              String?
  caste                 String?
  category              String?
  motherTongue          String?
  birthPlace            String?
  previousSchool        String?
  previousClass         String?
  tcNumber              String?
  medicalConditions     String?
  specialNeeds          String?
  fatherName            String?
  fatherOccupation      String?
  fatherPhone           String?
  fatherEmail           String?
  fatherAadhaar         String?                  @db.VarChar(12)
  motherName            String?
  motherOccupation      String?
  motherPhone           String?
  motherEmail           String?
  motherAadhaar         String?                  @db.VarChar(12)
  guardianName          String?
  guardianRelation      String?
  guardianPhone         String?
  guardianEmail         String?
  guardianAadhaar       String?                  @db.VarChar(12)
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt
  phone                 String?
  emergencyPhone        String?
  parentMobile          String?
  schoolId              String
  admissionApplication  AdmissionApplication?
  assignments           AssignmentSubmission[]
  bookIssues            BookIssue[]
  bookReservations      BookReservation[]
  enrollments           ClassEnrollment[]
  examResults           ExamResult[]
  feePayments           FeePayment[]
  reportCards           ReportCard[]
  scholarships          ScholarshipRecipient[]
  school                School                   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user                  User                     @relation(fields: [userId], references: [id], onDelete: Cascade)
  attendance            StudentAttendance[]
  parents               StudentParent[]
  settings              StudentSettings?
  alumni                Alumni?
  coScholasticGrades    CoScholasticGrade[]
  courseDiscussions     CourseDiscussion[]
  courseEnrollments     CourseEnrollment[]
  examAttempts          ExamAttempt[]
  hostelComplaints      HostelComplaint[]
  hostelRoomAllocations HostelRoomAllocation[]
  hostelVisitors        HostelVisitor[]
  paymentReceipts       PaymentReceipt[]
  promotionRecords      PromotionRecord[]
  quizAttempts          QuizAttempt[]
  routes                StudentRoute[]
  achievements          StudentAchievement[]
  xpLevel               StudentXPLevel?
  notes                 StudentNote[]
  flashcardDecks        FlashcardDeck[]
  flashcards            Flashcard[]
  mindMaps              MindMap[]
  contentProgress       StudentContentProgress[]

  @@index([aadhaarNumber])
  @@index([abcId])
  @@index([schoolId])
  @@index([parentMobile])
}

model StudentSettings {
  id                        String            @id @default(cuid())
  studentId                 String            @unique
  emailNotifications        Boolean           @default(true)
  assignmentReminders       Boolean           @default(true)
  examReminders             Boolean           @default(true)
  attendanceAlerts          Boolean           @default(true)
  feeReminders              Boolean           @default(true)
  eventNotifications        Boolean           @default(true)
  announcementNotifications Boolean           @default(true)
  whatsappNotifications     Boolean           @default(false)
  whatsappOptIn             Boolean           @default(false)
  profileVisibility         ProfileVisibility @default(PRIVATE)
  showEmail                 Boolean           @default(false)
  showPhone                 Boolean           @default(false)
  theme                     Theme             @default(LIGHT)
  colorTheme                String            @default("blue")
  language                  String            @default("en")
  dateFormat                String            @default("MM/DD/YYYY")
  timeFormat                TimeFormat        @default(TWELVE_HOUR)
  preferredLanguage         String            @default("en")
  createdAt                 DateTime          @default(now())
  updatedAt                 DateTime          @updatedAt
  schoolId                  String
  school                    School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student                   Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([preferredLanguage])
  @@index([schoolId])
}

model Parent {
  id             String          @id @default(cuid())
  userId         String          @unique
  occupation     String?
  alternatePhone String?
  relation       String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  schoolId       String
  school         School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user           User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  meetings       ParentMeeting[]
  settings       ParentSettings?
  children       StudentParent[]

  @@index([schoolId])
}

model ParentSettings {
  id                        String                @id @default(cuid())
  parentId                  String                @unique
  emailNotifications        Boolean               @default(true)
  smsNotifications          Boolean               @default(false)
  pushNotifications         Boolean               @default(true)
  feeReminders              Boolean               @default(true)
  attendanceAlerts          Boolean               @default(true)
  examResultNotifications   Boolean               @default(true)
  announcementNotifications Boolean               @default(true)
  meetingReminders          Boolean               @default(true)
  whatsappNotifications     Boolean               @default(false)
  preferredContactMethod    ContactMethod         @default(EMAIL)
  notificationFrequency     NotificationFrequency @default(IMMEDIATE)
  whatsappOptIn             Boolean               @default(false)
  whatsappNumber            String?
  profileVisibility         ProfileVisibility     @default(PRIVATE)
  theme                     Theme                 @default(LIGHT)
  colorTheme                String                @default("blue")
  language                  String                @default("en")
  preferredLanguage         String                @default("en")
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  schoolId                  String
  parent                    Parent                @relation(fields: [parentId], references: [id], onDelete: Cascade)
  school                    School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([parentId])
  @@index([preferredLanguage])
  @@index([schoolId])
}

model StudentParent {
  id        String   @id @default(cuid())
  studentId String
  parentId  String
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  schoolId  String
  parent    Parent   @relation(fields: [parentId], references: [id], onDelete: Cascade)
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([studentId, parentId])
  @@index([parentId])
  @@index([studentId])
  @@index([schoolId])
}

model AcademicYear {
  id            String         @id @default(cuid())
  name          String
  startDate     DateTime
  endDate       DateTime
  isCurrent     Boolean        @default(false)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  schoolId      String
  school        School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  budgets       Budget[]
  classes       Class[]
  feeStructures FeeStructure[]
  syllabi       Syllabus[]
  terms         Term[]

  @@index([schoolId])
}

model Term {
  id                 String              @id @default(cuid())
  name               String
  academicYearId     String
  startDate          DateTime
  endDate            DateTime
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  schoolId           String
  exams              Exam[]
  reportCards        ReportCard[]
  academicYear       AcademicYear        @relation(fields: [academicYearId], references: [id])
  school             School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  coScholasticGrades CoScholasticGrade[]

  @@unique([schoolId, name])
  @@index([schoolId])
}

model Department {
  id          String    @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  schoolId    String
  school      School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subjects    Subject[]
  teachers    Teacher[] @relation("DepartmentTeachers")

  @@unique([schoolId, name])
  @@index([schoolId])
}

model Class {
  id                    String                 @id @default(cuid())
  name                  String
  academicYearId        String
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  reportCardTemplateId  String?
  schoolId              String
  admissionApplications AdmissionApplication[]
  assessmentRules       AssessmentRule[]
  assignments           AssignmentClass[]
  academicYear          AcademicYear           @relation(fields: [academicYearId], references: [id])
  reportCardTemplate    ReportCardTemplate?    @relation(fields: [reportCardTemplateId], references: [id])
  school                School                 @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  enrollments           ClassEnrollment[]
  sections              ClassSection[]
  teachers              ClassTeacher[]
  feeStructures         FeeStructureClass[]
  feeTypeAmounts        FeeTypeClassAmount[]
  generatedMeritLists   MeritList[]            @relation("GeneratedMeritLists")
  meritListConfigs      MeritListConfig[]      @relation("MeritListConfigs")
  subjects              SubjectClass[]
  syllabi               Syllabus[]
  timetableSlots        TimetableSlot[]
  courses               Course[]
  onlineExams           OnlineExam[]

  @@unique([schoolId, name, academicYearId])
  @@index([schoolId])
}

model ClassSection {
  id                 String              @id @default(cuid())
  name               String
  classId            String
  capacity           Int?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  homeRoomId         String?             @unique
  schoolId           String
  enrollments        ClassEnrollment[]
  class              Class               @relation(fields: [classId], references: [id])
  homeRoom           ClassRoom?          @relation("HomeRoom", fields: [homeRoomId], references: [id])
  school             School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teachers           ClassTeacher[]
  attendanceRecords  StudentAttendance[]
  syllabi            Syllabus[]
  timetableSlots     TimetableSlot[]
  subjectAssignments SubjectClass[]

  @@unique([schoolId, name, classId])
  @@index([schoolId])
}

model ClassRoom {
  id              String          @id @default(cuid())
  name            String
  capacity        Int?
  building        String?
  floor           String?
  description     String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  schoolId        String
  school          School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  assignedSection ClassSection?   @relation("HomeRoom")
  timetableSlots  TimetableSlot[]

  @@unique([schoolId, name])
  @@index([schoolId])
}

model ClassTeacher {
  id          String        @id @default(cuid())
  classId     String
  sectionId   String?
  teacherId   String
  isClassHead Boolean       @default(false)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  schoolId    String
  class       Class         @relation(fields: [classId], references: [id])
  school      School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  section     ClassSection? @relation(fields: [sectionId], references: [id])
  teacher     Teacher       @relation(fields: [teacherId], references: [id])

  @@unique([classId, sectionId, teacherId])
  @@index([sectionId])
  @@index([schoolId])
}

model ClassEnrollment {
  id         String           @id @default(cuid())
  studentId  String
  classId    String
  sectionId  String
  rollNumber String?
  status     EnrollmentStatus @default(ACTIVE)
  enrollDate DateTime
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  schoolId   String
  class      Class            @relation(fields: [classId], references: [id])
  school     School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  section    ClassSection     @relation(fields: [sectionId], references: [id])
  student    Student          @relation(fields: [studentId], references: [id])

  @@unique([studentId, classId, sectionId])
  @@index([schoolId])
}

model Subject {
  id                String                @id @default(cuid())
  name              String
  code              String
  description       String?
  departmentId      String?
  type              SubjectType           @default(CORE)
  isCompulsory      Boolean               @default(false)
  hasTheory         Boolean               @default(true)
  hasPractical      Boolean               @default(false)
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  schoolId          String
  assignments       Assignment[]
  exams             Exam[]
  lessons           Lesson[]
  department        Department?           @relation(fields: [departmentId], references: [id])
  school            School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classes           SubjectClass[]
  groupMappings     SubjectGroupMapping[]
  teachers          SubjectTeacher[]
  variants          SubjectVariant[]
  syllabus          Syllabus[]
  courses           Course[]
  onlineExams       OnlineExam[]
  questionBanks     QuestionBank[]
  subjectMarkConfig SubjectMarkConfig[]

  @@unique([schoolId, code])
  @@index([schoolId])
}

model SubjectVariant {
  id           String   @id @default(cuid())
  subjectId    String
  variantType  String
  description  String?
  prerequisite String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  schoolId     String
  school       School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subject      Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([subjectId, variantType])
  @@index([schoolId])
}

model SubjectGroup {
  id                String                @id @default(cuid())
  name              String
  code              String                @unique
  description       String?
  boardType         String                @default("CBSE")
  applicableClasses String[]
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  schoolId          String
  school            School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subjects          SubjectGroupMapping[]

  @@index([schoolId])
}

model SubjectGroupMapping {
  id           String       @id @default(cuid())
  groupId      String
  subjectId    String
  isCompulsory Boolean      @default(false)
  schoolId     String
  subjectGroup SubjectGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  school       School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subject      Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([groupId, subjectId])
  @@index([schoolId])
}

model SubjectTeacher {
  id             String          @id @default(cuid())
  subjectId      String
  teacherId      String
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  schoolId       String
  school         School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subject        Subject         @relation(fields: [subjectId], references: [id])
  teacher        Teacher         @relation(fields: [teacherId], references: [id])
  timetableSlots TimetableSlot[]

  @@unique([subjectId, teacherId])
  @@index([schoolId])
}

model SubjectClass {
  id        String        @id @default(cuid())
  subjectId String
  classId   String
  sectionId String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  schoolId  String
  class     Class         @relation(fields: [classId], references: [id])
  school    School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  section   ClassSection? @relation(fields: [sectionId], references: [id])
  subject   Subject       @relation(fields: [subjectId], references: [id])

  @@unique([subjectId, classId, sectionId])
  @@index([sectionId])
  @@index([schoolId])
}

model Syllabus {
  id               String          @id @default(cuid())
  title            String
  description      String?
  subjectId        String
  academicYearId   String?
  classId          String?
  sectionId        String?
  curriculumType   CurriculumType  @default(GENERAL)
  boardType        String?
  assessmentType   AssessmentType  @default(GRADED)
  status           SyllabusStatus  @default(DRAFT)
  isActive         Boolean         @default(true)
  effectiveFrom    DateTime?
  effectiveTo      DateTime?
  version          String          @default("1.0")
  parentSyllabusId String?
  createdBy        String
  updatedBy        String?
  approvedBy       String?
  approvedAt       DateTime?
  tags             String[]
  difficultyLevel  DifficultyLevel @default(INTERMEDIATE)
  estimatedHours   Int?
  prerequisites    String?
  document         String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  schoolId         String
  modules          Module[]        @relation("SyllabusModules")
  academicYear     AcademicYear?   @relation(fields: [academicYearId], references: [id])
  class            Class?          @relation(fields: [classId], references: [id])
  parentSyllabus   Syllabus?       @relation("SyllabusVersions", fields: [parentSyllabusId], references: [id])
  childVersions    Syllabus[]      @relation("SyllabusVersions")
  school           School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  section          ClassSection?   @relation(fields: [sectionId], references: [id])
  subject          Subject         @relation(fields: [subjectId], references: [id])
  units            SyllabusUnit[]

  @@unique([subjectId, academicYearId, classId, sectionId, curriculumType])
  @@index([subjectId, classId])
  @@index([academicYearId, isActive])
  @@index([status, isActive])
  @@index([curriculumType, boardType])
  @@index([schoolId])
}

model SyllabusUnit {
  id          String   @id @default(cuid())
  title       String
  description String?
  syllabusId  String
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  schoolId    String
  lessons     Lesson[]
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  syllabus    Syllabus @relation(fields: [syllabusId], references: [id], onDelete: Cascade)

  @@index([schoolId])
}

model Lesson {
  id             String        @id @default(cuid())
  title          String
  description    String?
  subjectId      String
  syllabusUnitId String?
  content        String?
  resources      String?
  duration       Int?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  schoolId       String
  school         School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subject        Subject       @relation(fields: [subjectId], references: [id])
  syllabusUnit   SyllabusUnit? @relation(fields: [syllabusUnitId], references: [id])

  @@index([schoolId])
}

model Module {
  id            String             @id @default(cuid())
  title         String
  description   String?
  chapterNumber Int
  term          String?
  weightage     Float?
  order         Int
  syllabusId    String
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  schoolId      String
  school        School             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  syllabus      Syllabus           @relation("SyllabusModules", fields: [syllabusId], references: [id], onDelete: Cascade)
  subModules    SubModule[]
  documents     SyllabusDocument[]

  @@unique([syllabusId, chapterNumber])
  @@index([syllabusId, order])
  @@index([syllabusId, chapterNumber])
  @@index([schoolId])
}

model SubModule {
  id              String              @id @default(cuid())
  title           String
  description     String?
  order           Int
  moduleId        String
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  schoolId        String
  module          Module              @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  school          School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  progress        SubModuleProgress[]
  documents       SyllabusDocument[]
  timetableSlots  TimetableSlot[]
  studentProgress LessonProgress[]

  @@index([moduleId, order])
  @@index([moduleId])
  @@index([schoolId])
}

model SyllabusDocument {
  id          String     @id @default(cuid())
  title       String
  description String?
  filename    String
  fileUrl     String
  fileType    String
  fileSize    Int
  order       Int
  moduleId    String?
  subModuleId String?
  uploadedBy  String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  schoolId    String
  module      Module?    @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  school      School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subModule   SubModule? @relation(fields: [subModuleId], references: [id], onDelete: Cascade)

  @@index([moduleId])
  @@index([subModuleId])
  @@index([moduleId, order])
  @@index([subModuleId, order])
  @@index([schoolId])
}

model SubModuleProgress {
  id          String    @id @default(cuid())
  subModuleId String
  teacherId   String
  completed   Boolean   @default(false)
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  schoolId    String
  school      School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subModule   SubModule @relation(fields: [subModuleId], references: [id], onDelete: Cascade)

  @@unique([subModuleId, teacherId])
  @@index([teacherId])
  @@index([subModuleId, teacherId])
  @@index([schoolId])
}

model Timetable {
  id            String          @id @default(cuid())
  name          String
  description   String?
  effectiveFrom DateTime
  effectiveTo   DateTime?
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  schoolId      String
  school        School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  slots         TimetableSlot[]

  @@index([schoolId])
}

model TimetableConfig {
  id         String            @id @default(cuid())
  name       String
  daysOfWeek String[]
  isActive   Boolean           @default(true)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  schoolId   String
  school     School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  periods    TimetablePeriod[]

  @@index([schoolId])
}

model TimetablePeriod {
  id        String          @id @default(cuid())
  name      String
  startTime DateTime
  endTime   DateTime
  order     Int
  configId  String
  schoolId  String
  config    TimetableConfig @relation(fields: [configId], references: [id], onDelete: Cascade)
  school    School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
}

model TimetableSlot {
  id               String         @id @default(cuid())
  timetableId      String
  classId          String
  sectionId        String?
  subjectTeacherId String
  roomId           String?
  topicId          String?
  day              DayOfWeek
  startTime        DateTime
  endTime          DateTime
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  schoolId         String
  class            Class          @relation(fields: [classId], references: [id])
  room             ClassRoom?     @relation(fields: [roomId], references: [id])
  school           School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  section          ClassSection?  @relation(fields: [sectionId], references: [id])
  subjectTeacher   SubjectTeacher @relation(fields: [subjectTeacherId], references: [id])
  timetable        Timetable      @relation(fields: [timetableId], references: [id])
  topic            SubModule?     @relation(fields: [topicId], references: [id])

  @@index([topicId])
  @@index([schoolId])
}

model ExamType {
  id                 String   @id @default(cuid())
  name               String
  description        String?
  weight             Float    @default(0)
  isActive           Boolean  @default(true)
  canRetest          Boolean  @default(false)
  includeInGradeCard Boolean  @default(true)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  schoolId           String
  exams              Exam[]
  school             School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
}

model Exam {
  id                String              @id @default(cuid())
  title             String
  examTypeId        String
  subjectId         String
  termId            String
  examDate          DateTime
  startTime         DateTime
  endTime           DateTime
  totalMarks        Float
  passingMarks      Float
  creatorId         String?
  instructions      String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  schoolId          String
  creator           Teacher?            @relation(fields: [creatorId], references: [id])
  examType          ExamType            @relation(fields: [examTypeId], references: [id])
  school            School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subject           Subject             @relation(fields: [subjectId], references: [id])
  term              Term                @relation(fields: [termId], references: [id])
  results           ExamResult[]
  subjectMarkConfig SubjectMarkConfig[]

  @@index([schoolId])
}

model ExamResult {
  id             String   @id @default(cuid())
  examId         String
  studentId      String
  marks          Float
  theoryMarks    Float?
  practicalMarks Float?
  internalMarks  Float?
  totalMarks     Float?
  percentage     Float?
  grade          String?
  remarks        String?
  isAbsent       Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  schoolId       String
  exam           Exam     @relation(fields: [examId], references: [id])
  school         School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student        Student  @relation(fields: [studentId], references: [id])

  @@unique([examId, studentId])
  @@index([studentId, examId])
  @@index([examId, marks])
  @@index([studentId, createdAt])
  @@index([schoolId])
}

model GradeScale {
  id          String   @id @default(cuid())
  boardType   String   @default("CBSE")
  grade       String
  minMarks    Float
  maxMarks    Float
  gradePoint  Float?
  gpa         Float?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, boardType, grade])
  @@index([schoolId])
}

model AssessmentRule {
  id        String             @id @default(cuid())
  name      String
  classId   String?
  subjectId String?
  ruleType  AssessmentRuleType
  examTypes String[]
  count     Int?
  weight    Float              @default(1.0)
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  schoolId  String
  class     Class?             @relation(fields: [classId], references: [id])
  school    School             @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
}

model Assignment {
  id           String                 @id @default(cuid())
  title        String
  description  String?
  subjectId    String
  assignedDate DateTime
  dueDate      DateTime
  totalMarks   Float
  creatorId    String?
  instructions String?
  attachments  String?
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt
  schoolId     String
  creator      Teacher?               @relation(fields: [creatorId], references: [id])
  school       School                 @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subject      Subject                @relation(fields: [subjectId], references: [id])
  classes      AssignmentClass[]
  submissions  AssignmentSubmission[]

  @@index([subjectId])
  @@index([dueDate])
  @@index([schoolId])
}

model AssignmentClass {
  id           String     @id @default(cuid())
  assignmentId String
  classId      String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @default(now())
  schoolId     String
  assignment   Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  class        Class      @relation(fields: [classId], references: [id])
  school       School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, classId])
  @@index([schoolId])
}

model AssignmentSubmission {
  id             String           @id @default(cuid())
  assignmentId   String
  studentId      String
  submissionDate DateTime?
  content        String?
  attachments    String?
  marks          Float?
  feedback       String?
  status         SubmissionStatus @default(PENDING)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @default(now())
  schoolId       String
  assignment     Assignment       @relation(fields: [assignmentId], references: [id])
  school         School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student        Student          @relation(fields: [studentId], references: [id])

  @@unique([assignmentId, studentId])
  @@index([studentId])
  @@index([status])
  @@index([schoolId])
}

model ReportCard {
  id               String              @id @default(cuid())
  studentId        String
  termId           String
  templateId       String?
  totalMarks       Float?
  averageMarks     Float?
  percentage       Float?
  grade            String?
  rank             Int?
  attendance       Float?
  coScholasticData Json?
  teacherRemarks   String?
  principalRemarks String?
  pdfUrl           String?
  isPublished      Boolean             @default(false)
  publishDate      DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @default(now())
  schoolId         String
  school           School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student          Student             @relation(fields: [studentId], references: [id])
  template         ReportCardTemplate? @relation(fields: [templateId], references: [id])
  term             Term                @relation(fields: [termId], references: [id])

  @@unique([studentId, termId])
  @@index([templateId])
  @@index([isPublished])
  @@index([schoolId])
}

model StudentAttendance {
  id        String           @id @default(cuid())
  studentId String
  date      DateTime
  sectionId String
  status    AttendanceStatus @default(PRESENT)
  reason    String?
  markedBy  String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @default(now())
  schoolId  String
  school    School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  section   ClassSection     @relation(fields: [sectionId], references: [id])
  student   Student          @relation(fields: [studentId], references: [id])

  @@unique([studentId, date, sectionId])
  @@index([studentId, date])
  @@index([sectionId, date, status])
  @@index([status])
  @@index([schoolId])
}

model TeacherAttendance {
  id        String           @id @default(cuid())
  teacherId String
  date      DateTime
  status    AttendanceStatus @default(PRESENT)
  reason    String?
  markedBy  String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @default(now())
  schoolId  String
  school    School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teacher   Teacher          @relation(fields: [teacherId], references: [id])

  @@unique([teacherId, date])
  @@index([schoolId])
}

model LeaveApplication {
  id            String      @id @default(cuid())
  applicantId   String
  applicantType String
  fromDate      DateTime
  toDate        DateTime
  reason        String
  status        LeaveStatus @default(PENDING)
  approvedById  String?
  approvedOn    DateTime?
  remarks       String?
  attachments   String?
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @default(now())
  schoolId      String
  school        School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
}

model FeeType {
  id            String               @id @default(cuid())
  name          String
  description   String?
  amount        Float
  frequency     FeeFrequency         @default(ANNUAL)
  isOptional    Boolean              @default(false)
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @default(now())
  schoolId      String
  feeStructures FeeStructureItem[]
  school        School               @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classAmounts  FeeTypeClassAmount[]

  @@index([schoolId])
}

model FeeStructure {
  id                String              @id @default(cuid())
  name              String
  academicYearId    String
  applicableClasses String?
  isTemplate        Boolean             @default(false)
  description       String?
  validFrom         DateTime
  validTo           DateTime?
  isActive          Boolean             @default(true)
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @default(now())
  schoolId          String
  payments          FeePayment[]
  academicYear      AcademicYear        @relation(fields: [academicYearId], references: [id])
  school            School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  classes           FeeStructureClass[]
  items             FeeStructureItem[]
  paymentReceipts   PaymentReceipt[]

  @@index([schoolId])
}

model FeeStructureItem {
  id             String       @id @default(cuid())
  feeStructureId String
  feeTypeId      String
  amount         Float
  dueDate        DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now())
  schoolId       String
  feeStructure   FeeStructure @relation(fields: [feeStructureId], references: [id], onDelete: Cascade)
  feeType        FeeType      @relation(fields: [feeTypeId], references: [id])
  school         School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([feeStructureId, feeTypeId])
  @@index([schoolId])
}

model FeeStructureClass {
  id             String       @id @default(cuid())
  feeStructureId String
  classId        String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  schoolId       String
  class          Class        @relation(fields: [classId], references: [id], onDelete: Cascade)
  feeStructure   FeeStructure @relation(fields: [feeStructureId], references: [id], onDelete: Cascade)
  school         School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([feeStructureId, classId])
  @@index([feeStructureId])
  @@index([classId])
  @@index([feeStructureId, classId])
  @@index([schoolId])
}

model FeeTypeClassAmount {
  id        String   @id @default(cuid())
  feeTypeId String
  classId   String
  amount    Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  schoolId  String
  class     Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  feeType   FeeType  @relation(fields: [feeTypeId], references: [id], onDelete: Cascade)
  school    School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([feeTypeId, classId])
  @@index([feeTypeId])
  @@index([classId])
  @@index([schoolId])
}

model FeePayment {
  id             String          @id @default(cuid())
  studentId      String
  feeStructureId String
  amount         Float
  paidAmount     Float
  balance        Float           @default(0)
  paymentDate    DateTime
  paymentMethod  PaymentMethod   @default(CASH)
  transactionId  String?
  receiptNumber  String?
  status         PaymentStatus   @default(PENDING)
  remarks        String?
  paymentSource  PaymentSource   @default(MANUAL)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @default(now())
  schoolId       String
  feeStructure   FeeStructure    @relation(fields: [feeStructureId], references: [id])
  school         School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student        Student         @relation(fields: [studentId], references: [id])
  paymentReceipt PaymentReceipt?

  @@index([studentId, status, paymentDate])
  @@index([paymentDate])
  @@index([status])
  @@index([schoolId])
}

model PaymentReceipt {
  id              String        @id @default(cuid())
  studentId       String
  feeStructureId  String
  amount          Float
  paymentDate     DateTime
  paymentMethod   PaymentMethod
  transactionRef  String?
  remarks         String?
  receiptImageUrl String
  receiptPublicId String
  status          ReceiptStatus @default(PENDING_VERIFICATION)
  verifiedBy      String?
  verifiedAt      DateTime?
  rejectionReason String?
  feePaymentId    String?       @unique
  referenceNumber String        @unique
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  schoolId        String
  feePayment      FeePayment?   @relation(fields: [feePaymentId], references: [id])
  feeStructure    FeeStructure  @relation(fields: [feeStructureId], references: [id])
  school          School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student         Student       @relation(fields: [studentId], references: [id])
  notes           ReceiptNote[]

  @@index([studentId, status])
  @@index([status, createdAt])
  @@index([feeStructureId])
  @@index([referenceNumber])
  @@index([schoolId])
  @@map("payment_receipts")
}

model ReceiptNote {
  id         String         @id @default(cuid())
  receiptId  String
  note       String
  authorId   String
  authorName String
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  schoolId   String
  receipt    PaymentReceipt @relation(fields: [receiptId], references: [id], onDelete: Cascade)
  school     School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([receiptId, createdAt])
  @@index([receiptId])
  @@index([schoolId])
  @@map("receipt_notes")
}

model Scholarship {
  id          String                 @id @default(cuid())
  name        String
  description String?
  amount      Float
  percentage  Float?
  criteria    String?
  duration    String?
  fundedBy    String?
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @default(now())
  schoolId    String
  school      School                 @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  recipients  ScholarshipRecipient[]

  @@index([schoolId])
}

model ScholarshipRecipient {
  id            String      @id @default(cuid())
  scholarshipId String
  studentId     String
  awardDate     DateTime
  endDate       DateTime?
  amount        Float
  status        String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @default(now())
  schoolId      String
  scholarship   Scholarship @relation(fields: [scholarshipId], references: [id])
  school        School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student       Student     @relation(fields: [studentId], references: [id])

  @@unique([scholarshipId, studentId])
  @@index([schoolId])
}

model Expense {
  id             String        @id @default(cuid())
  title          String
  description    String?
  amount         Float
  date           DateTime
  category       String
  paymentMethod  PaymentMethod @default(CASH)
  paymentStatus  PaymentStatus @default(COMPLETED)
  paidTo         String?
  approvedBy     String?
  receiptNumber  String?
  attachments    String?
  budgetId       String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @default(now())
  schoolId       String
  budgetCategory Budget?       @relation(fields: [budgetId], references: [id])
  school         School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
}

model Budget {
  id              String       @id @default(cuid())
  title           String
  description     String?
  academicYearId  String
  category        String
  allocatedAmount Float
  startDate       DateTime
  endDate         DateTime?
  status          String       @default("Active")
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @default(now())
  schoolId        String
  academicYear    AcademicYear @relation(fields: [academicYearId], references: [id])
  school          School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  expenses        Expense[]

  @@index([schoolId])
}

model SalaryStructure {
  id              String   @id @default(cuid())
  teacherId       String   @unique
  basic           Float    @default(0)
  hra             Float    @default(0)
  da              Float    @default(0)
  travelAllowance Float    @default(0)
  schoolId        String
  otherAllowances Json?
  providentFund   Float    @default(0)
  professionalTax Float    @default(0)
  tds             Float    @default(0)
  otherDeductions Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  school          School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teacher         Teacher  @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([teacherId])
}

model Payroll {
  id              String        @id @default(cuid())
  teacherId       String
  month           Int
  year            Int
  basicSalary     Float
  hra             Float         @default(0)
  da              Float         @default(0)
  travelAllowance Float         @default(0)
  otherAllowances Json?
  providentFund   Float         @default(0)
  professionalTax Float         @default(0)
  tds             Float         @default(0)
  otherDeductions Json?
  allowances      Float         @default(0)
  deductions      Float         @default(0)
  netSalary       Float
  paymentDate     DateTime?
  paymentMethod   PaymentMethod @default(BANK_TRANSFER)
  transactionId   String?
  status          PaymentStatus @default(PENDING)
  remarks         String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @default(now())
  schoolId        String
  school          School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teacher         Teacher       @relation(fields: [teacherId], references: [id])

  @@unique([teacherId, month, year])
  @@index([schoolId])
}

model Message {
  id          String    @id @default(cuid())
  senderId    String
  recipientId String
  subject     String?
  content     String
  isRead      Boolean   @default(false)
  readAt      DateTime?
  attachments String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now())
  schoolId    String
  recipient   User      @relation("ReceivedMessages", fields: [recipientId], references: [id])
  school      School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  sender      User      @relation("SentMessages", fields: [senderId], references: [id])

  @@index([recipientId, isRead])
  @@index([senderId])
  @@index([createdAt])
  @@index([schoolId])
}

model Announcement {
  id             String        @id @default(cuid())
  title          String
  content        String
  publisherId    String
  targetAudience String[]
  startDate      DateTime      @default(now())
  endDate        DateTime?
  isActive       Boolean       @default(true)
  attachments    String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @default(now())
  schoolId       String
  publisher      Administrator @relation(fields: [publisherId], references: [id])
  school         School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([isActive])
  @@index([startDate])
  @@index([schoolId])
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  title     String
  message   String
  type      String
  isRead    Boolean   @default(false)
  readAt    DateTime?
  link      String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @default(now())
  schoolId  String
  school    School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id])

  @@index([userId, isRead])
  @@index([createdAt])
  @@index([schoolId])
}

model ParentMeeting {
  id            String        @id @default(cuid())
  title         String
  description   String?
  parentId      String
  teacherId     String
  scheduledDate DateTime
  duration      Int?
  status        MeetingStatus @default(SCHEDULED)
  location      String?
  notes         String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @default(now())
  schoolId      String
  parent        Parent        @relation(fields: [parentId], references: [id])
  school        School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teacher       Teacher       @relation(fields: [teacherId], references: [id])

  @@index([parentId])
  @@index([teacherId])
  @@index([scheduledDate])
  @@index([status])
  @@index([schoolId])
}

model DocumentType {
  id          String     @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @default(now())
  schoolId    String
  documents   Document[]
  school      School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
}

model Document {
  id             String            @id @default(cuid())
  title          String
  description    String?
  fileName       String
  fileUrl        String
  fileType       String?
  fileSize       Int?
  userId         String
  documentTypeId String?
  category       DocumentCategory?
  isPublic       Boolean           @default(false)
  tags           String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @default(now())
  schoolId       String
  documentType   DocumentType?     @relation(fields: [documentTypeId], references: [id])
  school         School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user           User              @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([documentTypeId])
  @@index([category])
  @@index([createdAt])
  @@index([schoolId])
}

model Event {
  id                   String             @id @default(cuid())
  title                String
  description          String?
  startDate            DateTime
  endDate              DateTime
  location             String?
  organizer            String?
  type                 String?
  category             EventCategory?
  status               EventStatus        @default(UPCOMING)
  maxParticipants      Int?
  registrationDeadline DateTime?
  isPublic             Boolean            @default(true)
  thumbnail            String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @default(now())
  schoolId             String
  school               School             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  participants         EventParticipant[]
  rsvps                EventRSVP[]

  @@index([startDate])
  @@index([status])
  @@index([type])
  @@index([schoolId])
}

model EventParticipant {
  id               String   @id @default(cuid())
  eventId          String
  userId           String
  role             String   @default("ATTENDEE")
  registrationDate DateTime @default(now())
  attended         Boolean  @default(false)
  feedback         String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @default(now())
  schoolId         String
  event            Event    @relation(fields: [eventId], references: [id])
  school           School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([userId])
  @@index([eventId])
  @@index([schoolId])
}

model EventRSVP {
  id        String     @id @default(cuid())
  eventId   String
  userId    String
  status    RSVPStatus @default(PENDING)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  schoolId  String
  event     Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  school    School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@index([userId])
  @@index([eventId])
  @@index([schoolId])
}

model Achievement {
  id          String              @id @default(cuid())
  title       String
  description String?
  category    AchievementCategory
  date        DateTime
  teacherId   String
  documents   String[]
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  schoolId    String
  school      School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  teacher     Teacher             @relation(fields: [teacherId], references: [id], onDelete: Cascade)

  @@index([teacherId])
  @@index([category])
  @@index([date])
  @@index([schoolId])
}

model AuditLog {
  id        String      @id @default(cuid())
  userId    String?
  schoolId  String?
  action    AuditAction
  details   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime    @default(now())

  // Legacy fields for backward compatibility
  resource   String?
  resourceId String?
  changes    Json?
  timestamp  DateTime? @default(now())
  updatedAt  DateTime? @updatedAt
  checksum   String?

  // Relationships
  user   User?   @relation(fields: [userId], references: [id])
  school School? @relation(fields: [schoolId], references: [id])

  @@index([userId, createdAt])
  @@index([schoolId, createdAt])
  @@index([action, createdAt])
  @@index([createdAt])
  @@map("audit_logs")
}

model ComplianceReport {
  id              String   @id @default(cuid())
  reportType      String
  timeRange       Json
  generatedBy     String
  status          String
  reportData      Json
  filePath        String?
  createdAt       DateTime @default(now())
  generatedByUser User     @relation(fields: [generatedBy], references: [id])

  @@map("compliance_reports")
}

model AnalyticsEvent {
  id         String   @id @default(cuid())
  eventType  String
  schoolId   String?
  userId     String?
  properties Json
  timestamp  DateTime @default(now())
  school     School?  @relation(fields: [schoolId], references: [id])
  user       User?    @relation(fields: [userId], references: [id])

  @@index([eventType, timestamp])
  @@index([schoolId, timestamp])
  @@map("analytics_events")
}

model Book {
  id           String            @id @default(cuid())
  isbn         String            @unique
  title        String
  author       String
  publisher    String?
  category     String
  quantity     Int
  available    Int
  location     String?
  coverImage   String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  schoolId     String
  school       School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  issues       BookIssue[]
  reservations BookReservation[]

  @@index([category])
  @@index([title])
  @@index([schoolId])
}

model BookIssue {
  id         String      @id @default(cuid())
  bookId     String
  studentId  String
  issueDate  DateTime    @default(now())
  dueDate    DateTime
  returnDate DateTime?
  fine       Float       @default(0)
  status     IssueStatus @default(ISSUED)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  schoolId   String
  book       Book        @relation(fields: [bookId], references: [id])
  school     School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student    Student     @relation(fields: [studentId], references: [id])

  @@index([studentId, status])
  @@index([bookId, status])
  @@index([dueDate, status])
  @@index([schoolId])
}

model BookReservation {
  id         String            @id @default(cuid())
  bookId     String
  studentId  String
  reservedAt DateTime          @default(now())
  expiresAt  DateTime
  status     ReservationStatus @default(ACTIVE)
  schoolId   String
  book       Book              @relation(fields: [bookId], references: [id])
  school     School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student    Student           @relation(fields: [studentId], references: [id])

  @@index([studentId, status])
  @@index([bookId, status])
  @@index([schoolId])
}

model AdmissionApplication {
  id                String                @id @default(cuid())
  applicationNumber String                @unique
  studentName       String
  dateOfBirth       DateTime
  gender            String
  parentName        String
  parentEmail       String
  parentPhone       String
  address           String
  previousSchool    String?
  appliedClassId    String
  aadhaarNumber     String?               @db.VarChar(12)
  abcId             String?               @db.VarChar(50)
  nationality       String?               @default("Indian")
  religion          String?
  caste             String?
  category          String?
  motherTongue      String?
  birthPlace        String?
  bloodGroup        String?
  tcNumber          String?
  medicalConditions String?
  specialNeeds      String?
  fatherName        String?
  fatherOccupation  String?
  fatherPhone       String?
  fatherEmail       String?
  fatherAadhaar     String?               @db.VarChar(12)
  motherName        String?
  motherOccupation  String?
  motherPhone       String?
  motherEmail       String?
  motherAadhaar     String?               @db.VarChar(12)
  guardianName      String?
  guardianRelation  String?
  guardianPhone     String?
  guardianEmail     String?
  guardianAadhaar   String?               @db.VarChar(12)
  annualIncome      Decimal?              @db.Decimal(12, 2)
  studentId         String?               @unique
  status            ApplicationStatus     @default(SUBMITTED)
  submittedAt       DateTime              @default(now())
  reviewedAt        DateTime?
  reviewedBy        String?
  remarks           String?
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  schoolId          String
  appliedClass      Class                 @relation(fields: [appliedClassId], references: [id])
  school            School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student           Student?              @relation(fields: [studentId], references: [id])
  documents         ApplicationDocument[]
  meritListEntries  MeritListEntry[]

  @@index([status])
  @@index([appliedClassId, status])
  @@index([submittedAt])
  @@index([aadhaarNumber])
  @@index([abcId])
  @@index([studentId])
  @@index([schoolId])
}

model ApplicationDocument {
  id            String               @id @default(cuid())
  applicationId String
  type          DocumentTypeEnum
  url           String
  filename      String
  uploadedAt    DateTime             @default(now())
  schoolId      String
  application   AdmissionApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  school        School               @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([applicationId])
  @@index([schoolId])
}

model MeritListConfig {
  id             String      @id @default(cuid())
  name           String
  appliedClassId String
  schoolId       String
  criteria       Json
  isActive       Boolean     @default(true)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  meritLists     MeritList[]
  appliedClass   Class       @relation("MeritListConfigs", fields: [appliedClassId], references: [id])
  school         School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([appliedClassId])
  @@index([isActive])
}

model MeritList {
  id                String           @id @default(cuid())
  configId          String
  appliedClassId    String
  generatedAt       DateTime         @default(now())
  generatedBy       String?
  totalApplications Int
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  schoolId          String
  appliedClass      Class            @relation("GeneratedMeritLists", fields: [appliedClassId], references: [id])
  config            MeritListConfig  @relation(fields: [configId], references: [id])
  school            School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  entries           MeritListEntry[]

  @@index([configId])
  @@index([appliedClassId])
  @@index([generatedAt])
  @@index([schoolId])
}

model MeritListEntry {
  id            String               @id @default(cuid())
  meritListId   String
  applicationId String
  rank          Int
  score         Float
  createdAt     DateTime             @default(now())
  schoolId      String
  application   AdmissionApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  meritList     MeritList            @relation(fields: [meritListId], references: [id], onDelete: Cascade)
  school        School               @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([meritListId, applicationId])
  @@unique([meritListId, rank])
  @@index([meritListId])
  @@index([applicationId])
  @@index([rank])
  @@index([schoolId])
}

enum BackupType {
  MANUAL
  SCHEDULED
  AUTOMATIC
}

enum BackupStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

model Backup {
  id           String       @id @default(cuid())
  filename     String
  size         BigInt?
  location     String
  encrypted    Boolean      @default(true)
  type         BackupType   @default(MANUAL)
  status       BackupStatus @default(PENDING)
  includeFiles Boolean      @default(true)
  completedAt  DateTime?
  errorMessage String?
  createdAt    DateTime     @default(now())
  createdBy    String?
  schoolId     String
  school       School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([status])
  @@index([schoolId])
  @@index([type])
}

// School Settings Tables
model SchoolPermissions {
  id       String @id @default(cuid())
  schoolId String @unique
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // User Management Permissions
  manageStudents Boolean @default(true)
  manageTeachers Boolean @default(true)
  manageParents  Boolean @default(true)
  manageAdmins   Boolean @default(true)

  // Academic Permissions
  manageClasses       Boolean @default(true)
  manageSubjects      Boolean @default(true)
  manageSyllabus      Boolean @default(true)
  manageExams         Boolean @default(true)
  manageAssignments   Boolean @default(true)
  manageAttendance    Boolean @default(true)
  generateReportCards Boolean @default(true)

  // Communication Permissions
  messagingSystem     Boolean @default(true)
  notificationSystem  Boolean @default(true)
  announcementSystem  Boolean @default(true)
  whatsappIntegration Boolean @default(false)
  smsIntegration      Boolean @default(false)
  emailIntegration    Boolean @default(true)

  // Financial Permissions
  feeManagement     Boolean @default(true)
  paymentProcessing Boolean @default(true)
  financialReports  Boolean @default(true)

  // Advanced Features
  libraryManagement     Boolean @default(false)
  transportManagement   Boolean @default(false)
  hostelManagement      Boolean @default(false)
  alumniManagement      Boolean @default(false)
  certificateGeneration Boolean @default(false)

  // System Permissions
  backupRestore  Boolean @default(true)
  dataExport     Boolean @default(true)
  auditLogs      Boolean @default(true)
  apiAccess      Boolean @default(false)
  customBranding Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
}

model SchoolSettings {
  id       String @id @default(cuid())
  schoolId String @unique
  school   School @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  // ========== ONBOARDING & BASIC INFO ==========
  onboardingCompleted Boolean @default(false)
  onboardingStep      Int     @default(0)
  schoolName          String  @default("School Name")
  schoolAddress       String?
  schoolPhone         String?
  schoolEmail         String?
  schoolLogo          String?
  schoolWebsite       String?
  schoolFax           String?
  affiliationNumber   String?
  schoolCode          String?
  board               String? @default("CBSE")
  timezone            String  @default("UTC")
  tagline             String?

  // ========== ACADEMIC SETTINGS ==========
  currentAcademicYear String  @default("")
  currentTerm         String  @default("")
  defaultGradingScale String  @default("PERCENTAGE")
  attendanceThreshold Int     @default(75)
  lateArrivalMinutes  Int     @default(15)
  passingGrade        Int     @default(50)
  autoAttendance      Boolean @default(false)

  // ========== SECURITY - TWO-FACTOR AUTHENTICATION ==========
  twoFactorEnabled  Boolean  @default(false)
  twoFactorRequired Boolean  @default(false)
  twoFactorMethods  String[] @default(["SMS", "EMAIL"])

  // ========== SECURITY - SESSION MANAGEMENT ==========
  sessionTimeout              Int     @default(480) // minutes
  maxConcurrentSessions       Int     @default(3)
  forceLogoutOnPasswordChange Boolean @default(true)

  // ========== SECURITY - PASSWORD POLICY ==========
  passwordMinLength           Int     @default(8)
  passwordRequireUppercase    Boolean @default(true)
  passwordRequireLowercase    Boolean @default(true)
  passwordRequireNumbers      Boolean @default(true)
  passwordRequireSpecialChars Boolean @default(false)
  passwordExpiry              Int     @default(90) // days, 0 = never

  // ========== SECURITY - IP WHITELISTING ==========
  ipWhitelistEnabled Boolean  @default(false)
  allowedIPs         String[] @default([])
  blockUnknownIPs    Boolean  @default(false)

  // ========== SECURITY - AUDIT LOGGING ==========
  auditLoggingEnabled Boolean @default(true)
  auditLogLevel       String  @default("INFO")
  auditLogRetention   Int     @default(365) // days

  // ========== SECURITY - DATA ENCRYPTION ==========
  encryptSensitiveData Boolean @default(true)
  encryptionLevel      String  @default("AES-256")

  // ========== SECURITY - API SECURITY ==========
  rateLimitEnabled     Boolean @default(true)
  maxRequestsPerMinute Int     @default(100)
  requireApiKey        Boolean @default(false)

  // ========== DATA MANAGEMENT - BACKUP SETTINGS ==========
  autoBackupEnabled Boolean @default(true)
  backupFrequency   String  @default("DAILY") // HOURLY, DAILY, WEEKLY, MONTHLY
  backupRetention   Int     @default(30) // days
  includeFiles      Boolean @default(true)
  encryptBackups    Boolean @default(true)

  // ========== DATA MANAGEMENT - EXPORT SETTINGS ==========
  allowDataExport Boolean  @default(true)
  exportFormats   String[] @default(["CSV", "JSON", "PDF"])
  requireApproval Boolean  @default(true)

  // ========== DATA MANAGEMENT - DATA RETENTION ==========
  studentDataRetention Int     @default(7) // years
  messageRetention     Int     @default(90) // days
  autoCleanup          Boolean @default(false)

  // ========== DATA MANAGEMENT - STORAGE MANAGEMENT ==========
  storageQuota       Int     @default(1) // GB
  compressionEnabled Boolean @default(true)
  autoArchive        Boolean @default(true)
  archiveAfterDays   Int     @default(365)

  // ========== NOTIFICATIONS - EMAIL ==========
  emailEnabled           Boolean @default(true)
  emailAdmissionUpdates  Boolean @default(true)
  emailFeeReminders      Boolean @default(true)
  emailExamNotifications Boolean @default(true)
  emailAttendanceAlerts  Boolean @default(true)
  emailSystemUpdates     Boolean @default(true)

  // ========== NOTIFICATIONS - SMS ==========
  smsEnabled           Boolean @default(false)
  smsAdmissionUpdates  Boolean @default(false)
  smsFeeReminders      Boolean @default(true)
  smsExamNotifications Boolean @default(true)
  smsAttendanceAlerts  Boolean @default(true)
  smsEmergencyAlerts   Boolean @default(true)

  // ========== NOTIFICATIONS - WHATSAPP ==========
  whatsappEnabled           Boolean @default(false)
  whatsappAdmissionUpdates  Boolean @default(false)
  whatsappFeeReminders      Boolean @default(true)
  whatsappExamNotifications Boolean @default(true)
  whatsappAttendanceAlerts  Boolean @default(false)
  whatsappGeneralUpdates    Boolean @default(false)

  // ========== NOTIFICATIONS - PUSH ==========
  pushEnabled           Boolean @default(true)
  pushAdmissionUpdates  Boolean @default(true)
  pushFeeReminders      Boolean @default(true)
  pushExamNotifications Boolean @default(true)
  pushAttendanceAlerts  Boolean @default(true)
  pushSystemMaintenance Boolean @default(true)

  // ========== NOTIFICATIONS - LEGACY CHANNELS (for backward compatibility) ==========
  notifyEnrollment               Boolean  @default(true)
  notifyPayment                  Boolean  @default(true)
  notifyAttendance               Boolean  @default(true)
  notifyExamResults              Boolean  @default(true)
  notifyLeaveApps                Boolean  @default(true)
  enrollmentNotificationChannels String[] @default(["EMAIL", "IN_APP"])
  paymentNotificationChannels    String[] @default(["EMAIL", "IN_APP"])
  attendanceNotificationChannels String[] @default(["SMS", "IN_APP"])
  examResultNotificationChannels String[] @default(["EMAIL", "IN_APP"])
  leaveAppNotificationChannels   String[] @default(["EMAIL", "IN_APP"])

  // ========== NOTIFICATIONS - TIMING & DELIVERY ==========
  quietHoursEnabled    Boolean @default(true)
  quietHoursStart      String  @default("22:00")
  quietHoursEnd        String  @default("08:00")
  weekendNotifications Boolean @default(false)
  batchNotifications   Boolean @default(true)
  immediateEmergency   Boolean @default(true)
  digestFrequency      String  @default("DAILY") // IMMEDIATE, HOURLY, DAILY, WEEKLY

  // ========== BRANDING & THEME ==========
  defaultTheme      String  @default("LIGHT")
  defaultColorTheme String  @default("blue")
  primaryColor      String  @default("#3b82f6")
  secondaryColor    String  @default("#8b5cf6")
  accentColor       String?
  logoUrl           String?
  faviconUrl        String?
  emailLogo         String?
  emailFooter       String?
  emailSignature    String?
  letterheadLogo    String?
  letterheadText    String?
  documentFooter    String?

  // ========== SOCIAL MEDIA ==========
  facebookUrl  String?
  twitterUrl   String?
  linkedinUrl  String?
  instagramUrl String?

  // ========== LOCALIZATION ==========
  language   String @default("en")
  dateFormat String @default("mdy")

  // ========== PAYMENT SETTINGS ==========
  enableOnlinePayment       Boolean @default(false)
  enableOfflineVerification Boolean @default(true)
  onlinePaymentGateway      String?
  maxReceiptSizeMB          Int     @default(5)
  allowedReceiptFormats     String  @default("jpg,jpeg,png,pdf")
  autoNotifyOnVerification  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([schoolId])
  @@map("school_settings")
}

model ScheduledReport {
  id             String    @id @default(cuid())
  name           String
  description    String?
  dataSource     String
  selectedFields String
  filters        String
  sorting        String
  frequency      String
  scheduleTime   String
  dayOfWeek      Int?
  dayOfMonth     Int?
  recipients     String
  exportFormat   String    @default("pdf")
  active         Boolean   @default(true)
  lastRunAt      DateTime?
  nextRunAt      DateTime?
  createdBy      String
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  schoolId       String
  school         School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([active, nextRunAt])
  @@index([createdBy])
  @@index([schoolId])
  @@map("scheduled_reports")
}

model MessageTemplate {
  id                   String                  @id @default(cuid())
  schoolId             String
  name                 String
  description          String?
  type                 MessageType
  category             String?
  subject              String?
  body                 String
  whatsappTemplateName String?
  whatsappTemplateId   String?
  whatsappLanguage     String?
  whatsappStatus       WhatsAppTemplateStatus?
  dltTemplateId        String?
  variables            String
  isActive             Boolean                 @default(true)
  isDefault            Boolean                 @default(false)
  createdBy            String
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  school               School                  @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, name])
  @@index([type, isActive])
  @@index([category])
  @@index([createdBy])
  @@index([whatsappStatus])
  @@map("message_templates")
}

model MessageHistory {
  id                 String        @id @default(cuid())
  messageType        MessageType
  subject            String?
  body               String
  templateId         String?
  recipientCount     Int           @default(0)
  sentCount          Int           @default(0)
  failedCount        Int           @default(0)
  smsCount           Int           @default(0)
  emailCount         Int           @default(0)
  smsCost            Float         @default(0)
  emailCost          Float         @default(0)
  totalCost          Float         @default(0)
  status             MessageStatus @default(PENDING)
  recipientSelection Json
  results            Json?
  sentBy             String
  sentAt             DateTime      @default(now())
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  schoolId           String
  school             School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  sender             User          @relation("MessageHistorySentBy", fields: [sentBy], references: [id])

  @@index([sentBy])
  @@index([sentAt])
  @@index([status])
  @@index([messageType])
  @@index([templateId])
  @@index([schoolId])
  @@map("message_history")
}

model MessageLog {
  id            String               @id @default(cuid())
  channel       CommunicationChannel
  recipient     String
  userId        String?
  templateId    String?
  subject       String?
  body          String?
  status        MessageLogStatus
  messageId     String?
  errorCode     String?
  errorMessage  String?
  sentAt        DateTime?
  deliveredAt   DateTime?
  readAt        DateTime?
  failedAt      DateTime?
  estimatedCost Decimal?             @db.Decimal(10, 4)
  metadata      Json?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  schoolId      String
  school        School               @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([channel, createdAt])
  @@index([userId, createdAt])
  @@index([status, createdAt])
  @@index([schoolId])
  @@map("message_logs")
}

model CommunicationErrorLog {
  id           String                @id @default(cuid())
  message      String
  category     ErrorCategory
  severity     ErrorSeverity
  channel      CommunicationChannel?
  errorCode    String?
  errorDetails String?
  recipient    String?
  userId       String?
  messageId    String?
  metadata     Json?
  stackTrace   String?
  resolved     Boolean               @default(false)
  resolvedAt   DateTime?
  resolvedBy   String?
  createdAt    DateTime              @default(now())
  updatedAt    DateTime              @updatedAt
  schoolId     String
  school       School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([category, createdAt])
  @@index([severity, createdAt])
  @@index([channel, createdAt])
  @@index([resolved, createdAt])
  @@index([schoolId])
  @@map("communication_error_logs")
}

model CertificateTemplate {
  id           String                 @id @default(cuid())
  schoolId     String
  name         String
  description  String?
  type         CertificateType
  category     String?
  layout       String
  styling      String
  content      String
  mergeFields  String
  pageSize     String                 @default("A4")
  orientation  String                 @default("LANDSCAPE")
  headerImage  String?
  footerImage  String?
  background   String?
  signature1   String?
  signature2   String?
  isActive     Boolean                @default(true)
  isDefault    Boolean                @default(false)
  createdBy    String
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt
  school       School                 @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  certificates GeneratedCertificate[]

  @@unique([schoolId, name])
  @@index([type, isActive])
  @@index([category])
  @@index([createdBy])
  @@map("certificate_templates")
}

model GeneratedCertificate {
  id                String              @id @default(cuid())
  certificateNumber String              @unique
  templateId        String
  studentId         String?
  studentName       String
  data              Json
  pdfUrl            String?
  verificationCode  String              @unique
  isVerified        Boolean             @default(true)
  status            CertificateStatus   @default(ACTIVE)
  issuedDate        DateTime            @default(now())
  issuedBy          String
  revokedAt         DateTime?
  revokedBy         String?
  revokedReason     String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  schoolId          String
  school            School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  template          CertificateTemplate @relation(fields: [templateId], references: [id])

  @@index([certificateNumber])
  @@index([verificationCode])
  @@index([studentId])
  @@index([templateId])
  @@index([issuedDate])
  @@index([status])
  @@index([schoolId])
  @@map("generated_certificates")
}

model Vehicle {
  id             String   @id @default(cuid())
  schoolId       String
  registrationNo String
  vehicleType    String
  capacity       Int
  driverId       String?
  status         String   @default("ACTIVE")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  routes         Route[]
  driver         Driver?  @relation(fields: [driverId], references: [id])
  school         School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, registrationNo])
  @@index([status])
  @@index([driverId])
  @@map("vehicles")
}

model Driver {
  id        String    @id @default(cuid())
  schoolId  String
  name      String
  phone     String
  licenseNo String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  school    School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  vehicles  Vehicle[]

  @@unique([schoolId, licenseNo])
  @@index([licenseNo])
  @@map("drivers")
}

model Route {
  id        String         @id @default(cuid())
  name      String
  vehicleId String
  fee       Float
  status    String         @default("ACTIVE")
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  schoolId  String
  stops     RouteStop[]
  school    School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  vehicle   Vehicle        @relation(fields: [vehicleId], references: [id])
  students  StudentRoute[]

  @@index([vehicleId])
  @@index([status])
  @@index([schoolId])
  @@map("routes")
}

model RouteStop {
  id          String   @id @default(cuid())
  routeId     String
  stopName    String
  arrivalTime String
  sequence    Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  schoolId    String
  route       Route    @relation(fields: [routeId], references: [id], onDelete: Cascade)
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([routeId, sequence])
  @@index([schoolId])
  @@map("route_stops")
}

model StudentRoute {
  id         String                @id @default(cuid())
  studentId  String
  routeId    String
  pickupStop String
  dropStop   String
  createdAt  DateTime              @default(now())
  updatedAt  DateTime              @updatedAt
  schoolId   String
  route      Route                 @relation(fields: [routeId], references: [id])
  school     School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student    Student               @relation(fields: [studentId], references: [id])
  attendance TransportAttendance[]

  @@unique([studentId, routeId])
  @@index([routeId])
  @@index([studentId])
  @@index([schoolId])
  @@map("student_routes")
}

model TransportAttendance {
  id             String                    @id @default(cuid())
  studentRouteId String
  date           DateTime
  stopName       String
  attendanceType TransportAttendanceType
  status         TransportAttendanceStatus @default(PRESENT)
  recordedAt     DateTime                  @default(now())
  recordedBy     String?
  remarks        String?
  createdAt      DateTime                  @default(now())
  updatedAt      DateTime                  @updatedAt
  schoolId       String
  school         School                    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  studentRoute   StudentRoute              @relation(fields: [studentRouteId], references: [id], onDelete: Cascade)

  @@unique([studentRouteId, date, stopName, attendanceType])
  @@index([studentRouteId, date])
  @@index([date, status])
  @@index([schoolId])
  @@map("transport_attendance")
}

model QuestionBank {
  id            String       @id @default(cuid())
  question      String
  questionType  QuestionType
  options       Json?
  correctAnswer String?
  marks         Float
  subjectId     String
  topic         String?
  difficulty    Difficulty   @default(MEDIUM)
  createdBy     String
  usageCount    Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  schoolId      String
  teacher       Teacher      @relation(fields: [createdBy], references: [id])
  school        School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subject       Subject      @relation(fields: [subjectId], references: [id])

  @@index([subjectId, topic])
  @@index([difficulty])
  @@index([createdBy])
  @@index([schoolId])
  @@map("question_bank")
}

model OnlineExam {
  id                 String        @id @default(cuid())
  title              String
  subjectId          String
  classId            String
  duration           Int
  totalMarks         Float
  questions          Json
  startTime          DateTime
  endTime            DateTime
  instructions       String?
  randomizeQuestions Boolean       @default(true)
  allowReview        Boolean       @default(true)
  createdBy          String
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  schoolId           String
  attempts           ExamAttempt[]
  class              Class         @relation(fields: [classId], references: [id])
  teacher            Teacher       @relation(fields: [createdBy], references: [id])
  school             School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subject            Subject       @relation(fields: [subjectId], references: [id])

  @@index([classId, startTime])
  @@index([subjectId])
  @@index([createdBy])
  @@index([startTime, endTime])
  @@index([schoolId])
  @@map("online_exams")
}

model ExamAttempt {
  id          String            @id @default(cuid())
  examId      String
  studentId   String
  answers     Json
  score       Float?
  startedAt   DateTime          @default(now())
  submittedAt DateTime?
  status      ExamAttemptStatus @default(IN_PROGRESS)
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  schoolId    String
  exam        OnlineExam        @relation(fields: [examId], references: [id])
  school      School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student     Student           @relation(fields: [studentId], references: [id])

  @@unique([examId, studentId])
  @@index([studentId, status])
  @@index([examId, status])
  @@index([submittedAt])
  @@index([schoolId])
  @@map("exam_attempts")
}

model Permission {
  id              String           @id @default(cuid())
  name            String           @unique
  description     String?
  resource        String
  action          PermissionAction
  category        String?
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]
  userPermissions UserPermission[]

  @@index([resource, action])
  @@index([category])
  @@index([isActive])
  @@map("permissions")
}

model UserPermission {
  id           String     @id @default(cuid())
  userId       String
  permissionId String
  grantedBy    String?
  grantedAt    DateTime   @default(now())
  expiresAt    DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  user         User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, permissionId])
  @@index([userId])
  @@index([permissionId])
  @@index([expiresAt])
  @@map("user_permissions")
}

model RolePermission {
  id           String     @id @default(cuid())
  role         UserRole
  permissionId String
  isDefault    Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([role, permissionId])
  @@index([role])
  @@index([permissionId])
  @@map("role_permissions")
}

model Hostel {
  id          String            @id @default(cuid())
  name        String
  address     String?
  capacity    Int
  wardenId    String?
  wardenName  String?
  wardenPhone String?
  type        HostelType        @default(BOYS)
  status      String            @default("ACTIVE")
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  schoolId    String
  complaints  HostelComplaint[]
  rooms       HostelRoom[]
  school      School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([status])
  @@index([type])
  @@index([schoolId])
  @@map("hostels")
}

model HostelRoom {
  id               String                 @id @default(cuid())
  hostelId         String
  roomNumber       String
  floor            Int?
  roomType         RoomType               @default(SHARED)
  capacity         Int
  currentOccupancy Int                    @default(0)
  amenities        String?
  status           String                 @default("AVAILABLE")
  monthlyFee       Float
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  schoolId         String
  allocations      HostelRoomAllocation[]
  hostel           Hostel                 @relation(fields: [hostelId], references: [id], onDelete: Cascade)
  school           School                 @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([hostelId, roomNumber])
  @@index([hostelId, status])
  @@index([roomType])
  @@index([schoolId])
  @@map("hostel_rooms")
}

model HostelRoomAllocation {
  id            String             @id @default(cuid())
  roomId        String
  studentId     String
  bedNumber     String?
  allocatedDate DateTime           @default(now())
  vacatedDate   DateTime?
  status        AllocationStatus   @default(ACTIVE)
  remarks       String?
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  schoolId      String
  feePayments   HostelFeePayment[]
  room          HostelRoom         @relation(fields: [roomId], references: [id], onDelete: Cascade)
  school        School             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student       Student            @relation(fields: [studentId], references: [id])

  @@unique([roomId, studentId, allocatedDate])
  @@index([studentId, status])
  @@index([roomId, status])
  @@index([schoolId])
  @@map("hostel_room_allocations")
}

model HostelVisitor {
  id              String    @id @default(cuid())
  studentId       String
  visitorName     String
  visitorPhone    String?
  visitorRelation String?
  purpose         String?
  checkInTime     DateTime  @default(now())
  checkOutTime    DateTime?
  idProofType     String?
  idProofNumber   String?
  approvedBy      String?
  remarks         String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  schoolId        String
  school          School    @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student         Student   @relation(fields: [studentId], references: [id])

  @@index([studentId, checkInTime])
  @@index([checkInTime])
  @@index([schoolId])
  @@map("hostel_visitors")
}

model HostelFeePayment {
  id            String               @id @default(cuid())
  allocationId  String
  month         Int
  year          Int
  roomFee       Float
  messFee       Float
  otherCharges  Float                @default(0)
  totalAmount   Float
  paidAmount    Float                @default(0)
  balance       Float
  paymentDate   DateTime?
  paymentMethod PaymentMethod        @default(CASH)
  transactionId String?
  receiptNumber String?
  status        PaymentStatus        @default(PENDING)
  dueDate       DateTime
  remarks       String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  schoolId      String
  allocation    HostelRoomAllocation @relation(fields: [allocationId], references: [id])
  school        School               @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([allocationId, month, year])
  @@index([allocationId, status])
  @@index([status, dueDate])
  @@index([schoolId])
  @@map("hostel_fee_payments")
}

model HostelComplaint {
  id          String            @id @default(cuid())
  hostelId    String
  studentId   String
  category    ComplaintCategory
  subject     String
  description String
  priority    ComplaintPriority @default(MEDIUM)
  status      ComplaintStatus   @default(PENDING)
  assignedTo  String?
  resolvedBy  String?
  resolvedAt  DateTime?
  resolution  String?
  attachments String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  schoolId    String
  hostel      Hostel            @relation(fields: [hostelId], references: [id])
  school      School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student     Student           @relation(fields: [studentId], references: [id])

  @@index([hostelId, status])
  @@index([studentId, status])
  @@index([status, priority])
  @@index([createdAt])
  @@index([schoolId])
  @@map("hostel_complaints")
}

model Course {
  id          String             @id @default(cuid())
  title       String
  description String?
  subjectId   String?
  classId     String?
  teacherId   String
  thumbnail   String?
  duration    Int?
  level       CourseLevel        @default(BEGINNER)
  status      CourseStatus       @default(DRAFT)
  isPublished Boolean            @default(false)
  publishedAt DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  schoolId    String
  discussions CourseDiscussion[]
  enrollments CourseEnrollment[]
  modules     CourseModule[]
  class       Class?             @relation(fields: [classId], references: [id])
  school      School             @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subject     Subject?           @relation(fields: [subjectId], references: [id])
  teacher     Teacher            @relation(fields: [teacherId], references: [id])

  @@index([teacherId])
  @@index([subjectId])
  @@index([classId])
  @@index([status, isPublished])
  @@index([schoolId])
  @@map("courses")
}

model CourseModule {
  id          String         @id @default(cuid())
  courseId    String
  title       String
  description String?
  sequence    Int
  duration    Int?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  schoolId    String
  lessons     CourseLesson[]
  course      Course         @relation(fields: [courseId], references: [id], onDelete: Cascade)
  school      School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([courseId, sequence])
  @@index([schoolId])
  @@map("course_modules")
}

model CourseLesson {
  id          String           @id @default(cuid())
  moduleId    String
  title       String
  description String?
  sequence    Int
  duration    Int?
  lessonType  LessonType       @default(TEXT)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  schoolId    String
  contents    CourseContent[]
  module      CourseModule     @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  school      School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  progress    LessonProgress[]
  quizzes     LessonQuiz[]

  @@index([moduleId, sequence])
  @@index([schoolId])
  @@map("course_lessons")
}

model CourseContent {
  id             String       @id @default(cuid())
  lessonId       String
  contentType    ContentType
  title          String?
  url            String?
  content        String?
  duration       Int?
  fileSize       Int?
  sequence       Int
  isDownloadable Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  schoolId       String
  lesson         CourseLesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  school         School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([lessonId, sequence])
  @@index([schoolId])
  @@map("course_contents")
}

model CourseEnrollment {
  id                String                 @id @default(cuid())
  courseId          String
  studentId         String
  enrolledAt        DateTime               @default(now())
  completedAt       DateTime?
  progress          Float                  @default(0)
  status            EnrollmentCourseStatus @default(ACTIVE)
  lastAccessedAt    DateTime?
  certificateIssued Boolean                @default(false)
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  schoolId          String
  course            Course                 @relation(fields: [courseId], references: [id], onDelete: Cascade)
  school            School                 @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student           Student                @relation(fields: [studentId], references: [id])
  lessonProgress    LessonProgress[]

  @@unique([courseId, studentId])
  @@index([studentId, status])
  @@index([courseId, status])
  @@index([schoolId])
  @@map("course_enrollments")
}

model LessonProgress {
  id             String               @id @default(cuid())
  enrollmentId   String
  lessonId       String?
  subModuleId    String?
  status         LessonProgressStatus @default(NOT_STARTED)
  progress       Float                @default(0)
  timeSpent      Int                  @default(0)
  startedAt      DateTime?
  completedAt    DateTime?
  lastAccessedAt DateTime?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  schoolId       String
  enrollment     CourseEnrollment     @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)
  lesson         CourseLesson?        @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  school         School               @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subModule      SubModule?           @relation(fields: [subModuleId], references: [id], onDelete: Cascade)

  @@unique([enrollmentId, lessonId])
  @@unique([enrollmentId, subModuleId])
  @@index([enrollmentId, status])
  @@index([lessonId])
  @@index([subModuleId])
  @@index([schoolId])
  @@map("lesson_progress")
}

model CourseDiscussion {
  id         String            @id @default(cuid())
  courseId   String
  studentId  String
  title      String
  content    String
  isPinned   Boolean           @default(false)
  isResolved Boolean           @default(false)
  viewCount  Int               @default(0)
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  schoolId   String
  course     Course            @relation(fields: [courseId], references: [id], onDelete: Cascade)
  school     School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student    Student           @relation(fields: [studentId], references: [id])
  replies    DiscussionReply[]

  @@index([courseId, createdAt])
  @@index([studentId])
  @@index([isPinned, createdAt])
  @@index([schoolId])
  @@map("course_discussions")
}

model DiscussionReply {
  id           String           @id @default(cuid())
  discussionId String
  userId       String
  userType     String
  content      String
  isAnswer     Boolean          @default(false)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  schoolId     String
  discussion   CourseDiscussion @relation(fields: [discussionId], references: [id], onDelete: Cascade)
  school       School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([discussionId, createdAt])
  @@index([userId])
  @@index([schoolId])
  @@map("discussion_replies")
}

model LessonQuiz {
  id                 String        @id @default(cuid())
  lessonId           String
  title              String
  description        String?
  questions          Json
  passingScore       Float         @default(70)
  timeLimit          Int?
  maxAttempts        Int           @default(3)
  showCorrectAnswers Boolean       @default(true)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  schoolId           String
  lesson             CourseLesson  @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  school             School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  attempts           QuizAttempt[]

  @@index([lessonId])
  @@index([schoolId])
  @@map("lesson_quizzes")
}

model QuizAttempt {
  id            String     @id @default(cuid())
  quizId        String
  studentId     String
  answers       Json
  score         Float?
  isPassed      Boolean    @default(false)
  attemptNumber Int        @default(1)
  startedAt     DateTime   @default(now())
  submittedAt   DateTime?
  timeSpent     Int?
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  schoolId      String
  quiz          LessonQuiz @relation(fields: [quizId], references: [id], onDelete: Cascade)
  school        School     @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student       Student    @relation(fields: [studentId], references: [id])

  @@index([quizId, studentId])
  @@index([studentId, createdAt])
  @@index([schoolId])
  @@map("quiz_attempts")
}

model SubjectMarkConfig {
  id                String   @id @default(cuid())
  examId            String
  subjectId         String
  theoryMaxMarks    Float?
  practicalMaxMarks Float?
  internalMaxMarks  Float?
  totalMarks        Float
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  schoolId          String
  exam              Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  school            School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  subject           Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@unique([examId, subjectId])
  @@index([examId])
  @@index([subjectId])
  @@index([schoolId])
  @@map("subject_mark_configs")
}

model CoScholasticActivity {
  id             String              @id @default(cuid())
  name           String
  assessmentType String
  maxMarks       Float?
  isActive       Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  schoolId       String
  school         School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  grades         CoScholasticGrade[]

  @@index([isActive])
  @@index([schoolId])
  @@map("co_scholastic_activities")
}

model CoScholasticGrade {
  id         String               @id @default(cuid())
  activityId String
  studentId  String
  termId     String
  grade      String?
  marks      Float?
  remarks    String?
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt
  schoolId   String
  activity   CoScholasticActivity @relation(fields: [activityId], references: [id], onDelete: Cascade)
  school     School               @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student    Student              @relation(fields: [studentId], references: [id], onDelete: Cascade)
  term       Term                 @relation(fields: [termId], references: [id], onDelete: Cascade)

  @@unique([activityId, studentId, termId])
  @@index([studentId, termId])
  @@index([activityId])
  @@index([schoolId])
  @@map("co_scholastic_grades")
}

model ReportCardTemplate {
  id            String       @id @default(cuid())
  name          String
  description   String?
  type          String
  pageSize      String       @default("A4")
  orientation   String       @default("PORTRAIT")
  sections      Json
  styling       Json
  headerImage   String?
  footerImage   String?
  schoolLogo    String?
  schoolId      String
  signatures    Json?
  disclaimer    String?
  gradingConfig Json?
  isActive      Boolean      @default(true)
  isDefault     Boolean      @default(false)
  createdBy     String
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  classes       Class[]
  reportCards   ReportCard[]
  school        School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([schoolId, name])
  @@index([type, isActive])
  @@index([isDefault])
  @@map("report_card_templates")
}

model CalendarEventCategory {
  id          String          @id @default(cuid())
  name        String          @unique
  description String?
  color       String
  icon        String?
  isActive    Boolean         @default(true)
  order       Int             @default(0)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  schoolId    String
  school      School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  events      CalendarEvent[]

  @@index([isActive, order])
  @@index([schoolId])
  @@map("calendar_event_categories")
}

model CalendarEvent {
  id                String                @id @default(cuid())
  title             String
  description       String?
  categoryId        String
  startDate         DateTime
  endDate           DateTime
  isAllDay          Boolean               @default(false)
  location          String?
  visibleToRoles    String[]
  visibleToClasses  String[]
  visibleToSections String[]
  sourceType        EventSourceType?
  sourceId          String?
  isRecurring       Boolean               @default(false)
  recurrenceRule    String?
  recurrenceId      String?
  exceptionDates    DateTime[]
  attachments       String[]
  createdBy         String
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt
  schoolId          String
  category          CalendarEventCategory @relation(fields: [categoryId], references: [id])
  school            School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  notes             EventNote[]
  reminders         EventReminder[]

  @@index([startDate, endDate])
  @@index([categoryId])
  @@index([sourceType, sourceId])
  @@index([recurrenceId])
  @@index([createdBy])
  @@index([startDate, categoryId])
  @@index([isRecurring, recurrenceId])
  @@index([schoolId])
  @@map("calendar_events")
}

model EventNote {
  id        String        @id @default(cuid())
  eventId   String
  userId    String
  content   String
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  schoolId  String
  event     CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  school    School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([eventId, userId])
  @@index([userId])
  @@index([schoolId])
  @@map("event_notes")
}

model EventReminder {
  id           String        @id @default(cuid())
  eventId      String
  userId       String
  reminderTime DateTime
  reminderType ReminderType
  isSent       Boolean       @default(false)
  sentAt       DateTime?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  schoolId     String
  event        CalendarEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)
  school       School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([eventId, userId])
  @@index([userId, isSent])
  @@index([reminderTime, isSent])
  @@index([schoolId])
  @@map("event_reminders")
}

model UserCalendarPreferences {
  id                  String   @id @default(cuid())
  userId              String   @unique
  defaultView         String   @default("month")
  schoolId            String
  filterSettings      Json?
  defaultReminderTime Int      @default(1440)
  reminderTypes       String[]
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  school              School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("user_calendar_preferences")
}

model Alumni {
  id                    String   @id @default(cuid())
  studentId             String   @unique
  graduationDate        DateTime
  finalClass            String
  finalSection          String
  finalAcademicYear     String
  currentOccupation     String?
  currentEmployer       String?
  currentJobTitle       String?
  currentAddress        String?
  currentCity           String?
  currentState          String?
  currentCountry        String?  @default("India")
  currentPhone          String?
  currentEmail          String?
  higherEducation       String?
  collegeName           String?
  collegeLocation       String?
  graduationYearCollege Int?
  achievements          String?
  linkedInProfile       String?
  profilePhoto          String?
  allowCommunication    Boolean  @default(true)
  communicationEmail    String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  createdBy             String
  updatedBy             String?
  schoolId              String
  school                School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student               Student  @relation(fields: [studentId], references: [id])

  @@index([graduationDate])
  @@index([finalClass])
  @@index([currentCity])
  @@index([collegeName])
  @@index([currentOccupation])
  @@index([currentEmployer])
  @@index([graduationDate, finalClass])
  @@index([finalClass, graduationDate])
  @@index([currentCity, currentOccupation])
  @@index([schoolId])
  @@map("alumni")
}

model PromotionHistory {
  id                 String            @id @default(cuid())
  sourceAcademicYear String
  sourceClass        String
  sourceSection      String?
  targetAcademicYear String
  targetClass        String
  targetSection      String?
  totalStudents      Int
  promotedStudents   Int
  excludedStudents   Int
  failedStudents     Int
  executedAt         DateTime          @default(now())
  executedBy         String
  notes              String?
  excludedList       String?
  failureDetails     String?
  schoolId           String
  school             School            @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  records            PromotionRecord[]

  @@index([sourceAcademicYear, sourceClass])
  @@index([targetAcademicYear, targetClass])
  @@index([executedAt])
  @@index([schoolId])
  @@map("promotion_history")
}

model PromotionRecord {
  id                   String           @id @default(cuid())
  historyId            String
  studentId            String
  previousEnrollmentId String
  newEnrollmentId      String?
  status               PromotionStatus
  reason               String?
  createdAt            DateTime         @default(now())
  schoolId             String
  history              PromotionHistory @relation(fields: [historyId], references: [id], onDelete: Cascade)
  school               School           @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  student              Student          @relation(fields: [studentId], references: [id])

  @@index([historyId])
  @@index([studentId])
  @@index([schoolId])
  @@map("promotion_records")
}

model SavedReportConfig {
  id             String   @id @default(cuid())
  name           String
  description    String?
  dataSource     String
  selectedFields String[]
  filters        Json
  sorting        Json
  chartConfig    Json?
  userId         String
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  schoolId       String
  school         School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("saved_report_configs")
}

model SupportTicket {
  id           String          @id @default(cuid())
  ticketNumber String          @unique
  schoolId     String
  title        String
  description  String
  status       TicketStatus
  priority     TicketPriority
  assignedTo   String?
  createdBy    String
  resolvedAt   DateTime?
  metadata     Json?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  assignee     User?           @relation("AssignedTickets", fields: [assignedTo], references: [id])
  creator      User            @relation("CreatedTickets", fields: [createdBy], references: [id])
  school       School          @relation(fields: [schoolId], references: [id])
  comments     TicketComment[]

  @@map("support_tickets")
}

model TicketComment {
  id         String        @id @default(cuid())
  ticketId   String
  authorId   String
  content    String
  isInternal Boolean       @default(false)
  createdAt  DateTime      @default(now())
  author     User          @relation(fields: [authorId], references: [id])
  ticket     SupportTicket @relation(fields: [ticketId], references: [id])

  @@map("ticket_comments")
}

model KnowledgeBaseArticle {
  id          String   @id @default(cuid())
  title       String
  content     String
  category    String
  tags        String[]
  isPublished Boolean  @default(false)
  authorId    String
  viewCount   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  author      User     @relation(fields: [authorId], references: [id])

  @@index([category, isPublished])
  @@map("knowledge_base_articles")
}

enum PlanType {
  STARTER
  GROWTH
  DOMINATE
}

enum SchoolStatus {
  ACTIVE
  SUSPENDED
  DEACTIVATED
}

enum SubdomainStatus {
  PENDING
  DNS_CONFIGURED
  SSL_CONFIGURED
  ACTIVE
  FAILED
}

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
  PARENT
  SUPER_ADMIN
}

enum SubscriptionStatus {
  ACTIVE
  PAST_DUE
  CANCELED
  UNPAID
  INCOMPLETE
  INCOMPLETE_EXPIRED
  TRIALING
  PAUSED
}

enum InvoiceStatus {
  DRAFT
  OPEN
  PAID
  VOID
  UNCOLLECTIBLE
}

enum PaymentStatus {
  PENDING
  COMPLETED
  PARTIAL
  FAILED
  REFUNDED
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_FOR_CUSTOMER
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ProfileVisibility {
  PUBLIC
  PRIVATE
  CLASSMATES_ONLY
}

enum Theme {
  LIGHT
  DARK
  SYSTEM
}

enum TimeFormat {
  TWELVE_HOUR
  TWENTY_FOUR_HOUR
}

enum ContactMethod {
  EMAIL
  SMS
  WHATSAPP
  EMAIL_AND_SMS
  EMAIL_AND_WHATSAPP
  SMS_AND_WHATSAPP
  ALL
  BOTH
}

enum NotificationFrequency {
  IMMEDIATE
  DAILY_DIGEST
  WEEKLY_DIGEST
}

enum EnrollmentStatus {
  ACTIVE
  INACTIVE
  TRANSFERRED
  GRADUATED
}

enum SubjectType {
  CORE
  LANGUAGE
  ELECTIVE
  ADDITIONAL
  VOCATIONAL
  SKILL_BASED
}

enum DayOfWeek {
  MONDAY
  TUESDAY
  WEDNESDAY
  THURSDAY
  FRIDAY
  SATURDAY
  SUNDAY
}

enum SyllabusStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  PUBLISHED
  ARCHIVED
  DEPRECATED
}

enum CurriculumType {
  GENERAL
  ADVANCED
  REMEDIAL
  INTEGRATED
  VOCATIONAL
  SPECIAL_NEEDS
}

enum AssessmentRuleType {
  BEST_OF
  AVERAGE
  WEIGHTED_AVERAGE
  SUM
}

enum DifficultyLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  EXPERT
}

enum AssessmentType {
  GRADED
  CO_SCHOLASTIC
}

enum SubmissionStatus {
  PENDING
  SUBMITTED
  LATE
  GRADED
  RETURNED
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  HALF_DAY
  LEAVE
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum FeeFrequency {
  ONE_TIME
  MONTHLY
  QUARTERLY
  SEMI_ANNUAL
  ANNUAL
}

enum PaymentMethod {
  CASH
  CHEQUE
  CREDIT_CARD
  DEBIT_CARD
  BANK_TRANSFER
  ONLINE_PAYMENT
  SCHOLARSHIP
}

enum PaymentSource {
  MANUAL
  ONLINE
  RECEIPT_UPLOAD
}

enum ReceiptStatus {
  PENDING_VERIFICATION
  VERIFIED
  REJECTED
}

enum MeetingStatus {
  REQUESTED
  SCHEDULED
  COMPLETED
  CANCELLED
  RESCHEDULED
}

enum DocumentCategory {
  CERTIFICATE
  ID_PROOF
  TEACHING_MATERIAL
  LESSON_PLAN
  CURRICULUM
  POLICY
  OTHER
}

enum EventStatus {
  UPCOMING
  ONGOING
  COMPLETED
  CANCELLED
  POSTPONED
}

enum EventCategory {
  SCHOOL_EVENT
  TEACHER_MEETING
  PARENT_TEACHER_CONFERENCE
  PROFESSIONAL_DEVELOPMENT
  HOLIDAY
  EXAM
  OTHER
}

enum RSVPStatus {
  PENDING
  ACCEPTED
  DECLINED
  MAYBE
}

enum AchievementCategory {
  AWARD
  CERTIFICATION
  PROFESSIONAL_DEVELOPMENT
  PUBLICATION
  RECOGNITION
  OTHER
}

enum AuditAction {
  CREATE
  READ
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
  APPROVE
  REJECT
  PUBLISH
  ARCHIVE
  VERIFY
  VIEW
  UPLOAD
  REUPLOAD
  ADD_NOTE
  DELETE_NOTE
  BULK_VERIFY
  BULK_REJECT
}

enum IssueStatus {
  ISSUED
  RETURNED
  OVERDUE
  LOST
}

enum ReservationStatus {
  ACTIVE
  FULFILLED
  EXPIRED
  CANCELLED
}

enum ApplicationStatus {
  SUBMITTED
  UNDER_REVIEW
  ACCEPTED
  REJECTED
  WAITLISTED
}

enum DocumentTypeEnum {
  BIRTH_CERTIFICATE
  PREVIOUS_REPORT_CARD
  PHOTOGRAPH
  OTHER
}

enum MessageType {
  SMS
  EMAIL
  WHATSAPP
  BOTH
}

enum WhatsAppTemplateStatus {
  PENDING
  APPROVED
  REJECTED
}

enum MessageStatus {
  PENDING
  SENT
  FAILED
  PARTIALLY_SENT
}

enum CommunicationChannel {
  EMAIL
  SMS
  WHATSAPP
  IN_APP
}

enum MessageLogStatus {
  QUEUED
  SENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum ErrorCategory {
  CONFIGURATION
  AUTHENTICATION
  VALIDATION
  RATE_LIMIT
  NETWORK
  API_ERROR
  DATABASE
  UNKNOWN
}

enum ErrorSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum CertificateType {
  ACHIEVEMENT
  COMPLETION
  PARTICIPATION
  MERIT
  CHARACTER
  BONAFIDE
  TRANSFER
  CUSTOM
}

enum CertificateStatus {
  ACTIVE
  REVOKED
  EXPIRED
}

enum TransportAttendanceType {
  BOARDING
  ALIGHTING
}

enum TransportAttendanceStatus {
  PRESENT
  ABSENT
  LATE
}

enum QuestionType {
  MCQ
  TRUE_FALSE
  ESSAY
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum ExamAttemptStatus {
  IN_PROGRESS
  SUBMITTED
  AUTO_SUBMITTED
  GRADED
  CANCELLED
}

enum PermissionAction {
  CREATE
  READ
  UPDATE
  DELETE
  EXPORT
  IMPORT
  APPROVE
  REJECT
  PUBLISH
  ARCHIVE
}

enum HostelType {
  BOYS
  GIRLS
  MIXED
}

enum RoomType {
  SINGLE
  DOUBLE
  SHARED
}

enum AllocationStatus {
  ACTIVE
  VACATED
  TRANSFERRED
}

enum ComplaintCategory {
  ROOM_MAINTENANCE
  MESS_FOOD
  CLEANLINESS
  ELECTRICITY
  WATER_SUPPLY
  SECURITY
  NOISE
  OTHER
}

enum ComplaintPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ComplaintStatus {
  PENDING
  IN_PROGRESS
  RESOLVED
  CLOSED
  REJECTED
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum CourseStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum LessonType {
  TEXT
  VIDEO
  AUDIO
  DOCUMENT
  PRESENTATION
  INTERACTIVE
  QUIZ
}

enum ContentType {
  VIDEO
  AUDIO
  PDF
  DOCUMENT
  PRESENTATION
  IMAGE
  TEXT
  LINK
  EMBED
}

enum EnrollmentCourseStatus {
  ACTIVE
  COMPLETED
  DROPPED
  SUSPENDED
}

enum LessonProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}

enum EventSourceType {
  EXAM
  ASSIGNMENT
  MEETING
  HOLIDAY
  SCHOOL_EVENT
  MANUAL
}

enum ReminderType {
  EMAIL
  SMS
  PUSH
  IN_APP
}

enum PromotionStatus {
  PROMOTED
  EXCLUDED
  FAILED
}

// ============================================================================
// Monitoring and Alert Models
// ============================================================================

model SystemMetric {
  id         String   @id @default(cuid())
  metricName String
  value      Float
  unit       String?
  tags       Json?
  timestamp  DateTime @default(now())
  schoolId   String?

  school School? @relation(fields: [schoolId], references: [id])

  @@index([metricName, timestamp])
  @@index([schoolId, timestamp])
  @@map("system_metrics")
}

model Alert {
  id           String    @id @default(cuid())
  alertType    String
  severity     String // INFO, WARNING, ERROR, CRITICAL
  title        String
  description  String
  isResolved   Boolean   @default(false)
  resolvedAt   DateTime?
  resolvedBy   String?
  metadata     Json?
  threshold    Float?
  currentValue Float?
  schoolId     String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  resolver User?   @relation(fields: [resolvedBy], references: [id])
  school   School? @relation(fields: [schoolId], references: [id])

  @@index([alertType, isResolved])
  @@index([severity, createdAt])
  @@index([schoolId, isResolved])
  @@map("alerts")
}

model AlertConfig {
  id              String   @id @default(cuid())
  name            String
  alertType       String // error_rate, delivery_rate, api_error, critical_error, usage_threshold
  threshold       Float
  condition       String // greater, less, equal
  enabled         Boolean  @default(true)
  notifyAdmins    Boolean  @default(true)
  notifyEmail     Boolean  @default(false)
  emailRecipients String[] @default([])
  metadata        Json?
  schoolId        String?
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  creator User    @relation(fields: [createdBy], references: [id])
  school  School? @relation(fields: [schoolId], references: [id])

  @@index([alertType, enabled])
  @@index([schoolId])
  @@map("alert_configs")
}

model SystemHealth {
  id           String   @id @default(cuid())
  component    String   @unique // Make component unique for upsert operations
  status       String // HEALTHY, DEGRADED, DOWN
  responseTime Float? // in milliseconds
  errorRate    Float? // percentage
  lastChecked  DateTime @default(now())
  metadata     Json?

  @@index([component, lastChecked])
  @@index([status, lastChecked])
  @@map("system_health")
}

model PerformanceMetric {
  id         String   @id @default(cuid())
  metricType String // cpu_usage, memory_usage, disk_usage, response_time, throughput
  value      Float
  unit       String?
  component  String? // api, database, cache, etc.
  timestamp  DateTime @default(now())
  metadata   Json?

  @@index([metricType, timestamp])
  @@index([component, timestamp])
  @@map("performance_metrics")
}

// Rate Limiting and Abuse Protection Models
// Requirements: 14.1, 14.2, 14.3, 14.4, 14.5

model BlockedIdentifier {
  id         String   @id @default(cuid())
  identifier String // mobile or email
  reason     String // reason for blocking
  attempts   Int      @default(1)
  isActive   Boolean  @default(true)
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([identifier, isActive, expiresAt])
  @@index([expiresAt, isActive])
  @@map("blocked_identifiers")
}

model LoginFailure {
  id         String   @id @default(cuid())
  identifier String // mobile or email
  reason     String // failure reason
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([identifier, createdAt])
  @@index([createdAt])
  @@map("login_failures")
}

model RateLimitLog {
  id         String   @id @default(cuid())
  identifier String // mobile or email
  action     String // action type (RATE_LIMIT_HIT, IDENTIFIER_BLOCKED, etc.)
  type       String // rate limit type (OTP_GENERATION, LOGIN_ATTEMPTS, etc.)
  details    Json? // additional details
  createdAt  DateTime @default(now())

  @@index([identifier, action, createdAt])
  @@index([action, createdAt])
  @@index([createdAt])
  @@map("rate_limit_logs")
}

model EmergencyAccess {
  id                  String    @id @default(cuid())
  targetType          String // 'USER' or 'SCHOOL'
  targetId            String
  targetName          String
  action              String // 'DISABLE', 'ENABLE', 'FORCE_DISABLE'
  reason              String
  performedBy         String
  disabledUntil       DateTime?
  affectedUsers       Int       @default(0)
  invalidatedSessions Int       @default(0)
  isReversed          Boolean   @default(false)
  reversedAt          DateTime?
  reversedBy          String?
  reversedReason      String?
  metadata            Json?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relationships
  performedByUser User? @relation("EmergencyAccessPerformedBy", fields: [performedBy], references: [id])
  reversedByUser  User? @relation("EmergencyAccessReversedBy", fields: [reversedBy], references: [id])

  @@index([targetType, targetId])
  @@index([performedBy, createdAt])
  @@index([action, createdAt])
  @@index([isReversed, createdAt])
  @@index([targetType, action, isReversed])
  @@map("emergency_access")
}

// ============================================================================
// Student Portal Phase 2 Features
// ============================================================================

model StudentAchievement {
  id          String                  @id @default(cuid())
  studentId   String
  schoolId    String
  title       String
  description String?
  category    AchievementCategoryType
  points      Int                     @default(0)
  rarity      RarityType              @default(COMMON)
  icon        String                  @default("Star")
  unlocked    Boolean                 @default(false)
  unlockedAt  DateTime?
  progress    Int                     @default(0)
  maxProgress Int                     @default(1)
  metadata    Json?
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  school  School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([schoolId])
  @@index([category])
  @@index([unlocked])
  @@map("student_achievements")
}

model StudentXPLevel {
  id               String    @id @default(cuid())
  studentId        String    @unique
  schoolId         String
  totalXP          Int       @default(0)
  level            Int       @default(1)
  currentLevelXP   Int       @default(0)
  xpToNextLevel    Int       @default(100)
  streak           Int       @default(0)
  lastActivityDate DateTime?
  metadata         Json?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  school  School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([schoolId])
  @@index([level])
  @@map("student_xp_levels")
}

model StudentNote {
  id        String   @id @default(cuid())
  studentId String
  schoolId  String
  title     String
  content   String
  subject   String
  tags      String[]
  folder    String?
  isPublic  Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  school  School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([schoolId])
  @@index([subject])
  @@index([folder])
  @@map("student_notes")
}

model FlashcardDeck {
  id          String   @id @default(cuid())
  studentId   String
  schoolId    String
  name        String
  description String?
  subject     String
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  student Student     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  school  School      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  cards   Flashcard[]

  @@index([studentId])
  @@index([schoolId])
  @@index([subject])
  @@map("flashcard_decks")
}

model Flashcard {
  id             String         @id @default(cuid())
  deckId         String
  studentId      String
  schoolId       String
  front          String
  back           String
  difficulty     DifficultyType @default(MEDIUM)
  correctCount   Int            @default(0)
  incorrectCount Int            @default(0)
  lastReviewed   DateTime?
  tags           String[]
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  deck    FlashcardDeck @relation(fields: [deckId], references: [id], onDelete: Cascade)
  student Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  school  School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([deckId])
  @@index([studentId])
  @@index([schoolId])
  @@map("flashcards")
}

model MindMap {
  id          String   @id @default(cuid())
  studentId   String
  schoolId    String
  title       String
  subject     String
  nodes       Json
  connections Json
  isPublic    Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  school  School  @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([schoolId])
  @@index([subject])
  @@map("mind_maps")
}

model LessonContent {
  id        String            @id @default(cuid())
  lessonId  String?
  courseId  String?
  schoolId  String
  title     String
  type      LessonContentType
  content   String
  duration  Int? // in minutes
  order     Int               @default(0)
  metadata  Json?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  school          School                   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  studentProgress StudentContentProgress[]

  @@index([lessonId])
  @@index([courseId])
  @@index([schoolId])
  @@index([order])
  @@map("lesson_contents")
}

model StudentContentProgress {
  id             String         @id @default(cuid())
  studentId      String
  contentId      String
  schoolId       String
  status         ProgressStatus @default(NOT_STARTED)
  progress       Float          @default(0)
  timeSpent      Int            @default(0) // in seconds
  completed      Boolean        @default(false)
  completedAt    DateTime?
  lastAccessedAt DateTime?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  student Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  content LessonContent @relation(fields: [contentId], references: [id], onDelete: Cascade)
  school  School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@unique([studentId, contentId])
  @@index([studentId])
  @@index([contentId])
  @@index([schoolId])
  @@map("student_content_progress")
}

// Add new enum types
enum AchievementCategoryType {
  ACADEMIC
  ATTENDANCE
  PARTICIPATION
  STREAK
  SPECIAL
}

enum RarityType {
  COMMON
  RARE
  EPIC
  LEGENDARY
}

enum DifficultyType {
  EASY
  MEDIUM
  HARD
}

enum LessonContentType {
  VIDEO
  TEXT
  AUDIO
  INTERACTIVE
}

enum ProgressStatus {
  NOT_STARTED
  IN_PROGRESS
  COMPLETED
}
