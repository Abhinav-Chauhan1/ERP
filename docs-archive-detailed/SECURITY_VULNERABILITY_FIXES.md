# Security Vulnerability Fixes

## Overview

This document outlines the security vulnerability fixes implemented to address critical and high-severity issues in the project dependencies.

**Date:** January 11, 2026  
**Status:** ✅ Complete - All vulnerabilities resolved

## Vulnerabilities Fixed

### 1. jsPDF - Local File Inclusion/Path Traversal (Critical)

**Issue:** jsPDF ≤3.0.4 had a Local File Inclusion/Path Traversal vulnerability  
**Severity:** Critical  
**CVE:** GHSA-f8cm-6447-x5h2

**Resolution:**
- Upgraded from `jspdf@3.0.4` to `jspdf@4.0.0` (latest)
- Upgraded `jspdf-autotable` to latest compatible version
- Updated import syntax from `import jsPDF from 'jspdf'` to `import { jsPDF } from 'jspdf'`

**Files Updated:**
- `src/lib/utils/export.ts`
- `src/lib/services/scheduled-report-service.ts`
- `src/lib/services/report-card-pdf-generation.ts`
- `src/lib/services/idCardGenerationService.ts`
- `src/lib/services/certificateGenerationService.ts`
- `src/lib/actions/subjectPerformanceActions.ts`
- `src/app/admin/assessment/consolidated-mark-sheet/page.tsx`
- `src/app/admin/attendance/reports/page.tsx`

### 2. xlsx (SheetJS) - Prototype Pollution & ReDoS (High)

**Issue:** xlsx library had Prototype Pollution and Regular Expression Denial of Service vulnerabilities  
**Severity:** High  
**CVEs:** 
- GHSA-4r6h-8v6p-xvw6 (Prototype Pollution)
- GHSA-5pgg-2g8v-p4x9 (ReDoS)

**Resolution:**
- Completely removed `xlsx@0.18.5` dependency
- Migrated to `exceljs` - a secure, actively maintained alternative
- Created new utility module `src/lib/utils/excel.ts` with ExcelJS

**Migration Benefits:**
- ✅ No security vulnerabilities
- ✅ Better TypeScript support
- ✅ More features (styling, formatting, merged cells)
- ✅ Actively maintained
- ✅ Better performance for large files

**Files Updated:**
- `src/lib/utils/export.ts` - Updated to use ExcelJS
- `src/lib/utils/excel.ts` - New utility module created
- `src/lib/actions/export-actions.ts` - Removed xlsx import
- `src/lib/services/scheduled-report-service.ts` - Migrated to ExcelJS
- `src/lib/actions/subjectPerformanceActions.ts` - Migrated to ExcelJS
- `src/components/admin/import-marks-dialog.tsx` - Updated Excel parsing
- `src/components/admin/export-marks-dialog.tsx` - Updated Excel export
- `src/app/admin/finance/analytics/page.tsx` - Migrated to ExcelJS
- `src/app/admin/assessment/consolidated-mark-sheet/page.tsx` - Migrated to ExcelJS
- `src/lib/utils/export.test.ts` - Updated test imports

## New ExcelJS Utility

### Location
`src/lib/utils/excel.ts`

### Key Functions

#### `exportToExcel(data, options)`
Export data to Excel format with styling and formatting.

```typescript
await exportToExcel(data, {
  filename: 'report',
  title: 'Monthly Report',
  subtitle: 'January 2026',
  includeTimestamp: true,
});
```

#### `parseExcelFile(file)`
Parse Excel file and return JSON data.

```typescript
const data = await parseExcelFile(file);
```

#### `createExcelTemplate(columns, filename)`
Create Excel template for import with example data.

```typescript
await createExcelTemplate([
  { key: 'name', header: 'Name', example: 'John Doe' },
  { key: 'email', header: 'Email', example: 'john@example.com' },
], 'template');
```

### Features
- Automatic column width calculation
- Header styling (bold, colored background)
- Alternate row colors for better readability
- Border styling
- Metadata support (title, subtitle, timestamp)
- Type-safe with TypeScript

## Migration Guide

### For Developers

If you need to add new Excel export/import functionality:

**Old Way (xlsx):**
```typescript
import * as XLSX from 'xlsx';

const wb = XLSX.utils.book_new();
const ws = XLSX.utils.json_to_sheet(data);
XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
XLSX.writeFile(wb, 'file.xlsx');
```

**New Way (ExcelJS):**
```typescript
import { exportToExcel } from '@/lib/utils/excel';

await exportToExcel(data, {
  filename: 'file',
  title: 'My Report',
});
```

### For Excel Parsing

**Old Way:**
```typescript
const reader = new FileReader();
reader.onload = (e) => {
  const data = e.target?.result;
  const workbook = XLSX.read(data, { type: "binary" });
  const worksheet = workbook.Sheets[workbook.SheetNames[0]];
  const jsonData = XLSX.utils.sheet_to_json(worksheet);
};
reader.readAsBinaryString(file);
```

**New Way:**
```typescript
import { parseExcelFile } from '@/lib/utils/excel';

const jsonData = await parseExcelFile(file);
```

## Testing

### Manual Testing Checklist

- [x] PDF generation (report cards, certificates, ID cards)
- [x] Excel export (marks, analytics, reports)
- [x] Excel import (marks import)
- [x] CSV export functionality
- [x] Scheduled reports with attachments
- [x] All export dialogs and buttons

### Automated Testing

Run the test suite to verify no regressions:

```bash
npm test
```

## Verification

### Check for Vulnerabilities

```bash
npm audit
```

**Expected Output:**
```
found 0 vulnerabilities
```

### Check Installed Packages

```bash
npm list jspdf exceljs
```

**Expected Output:**
```
├── exceljs@4.x.x
└── jspdf@4.x.x
```

## Performance Impact

### jsPDF v4
- Minimal performance impact
- Improved security
- Better TypeScript support

### ExcelJS vs xlsx
- Slightly slower for very large files (>10,000 rows)
- Better memory management
- More features and better styling
- Overall: Acceptable trade-off for security

## Breaking Changes

### jsPDF Import Syntax

**Before:**
```typescript
import jsPDF from 'jspdf';
const doc = new jsPDF();
```

**After:**
```typescript
import { jsPDF } from 'jspdf';
const doc = new jsPDF();
```

### Excel Export is Now Async

**Before:**
```typescript
exportToExcel(data, options); // Synchronous
```

**After:**
```typescript
await exportToExcel(data, options); // Asynchronous
```

## Rollback Procedure

If issues arise, you can rollback:

```bash
# Rollback jsPDF (not recommended due to security)
npm install jspdf@3.0.4 jspdf-autotable@3.8.4

# Rollback to xlsx (not recommended due to security)
npm install xlsx@0.18.5
```

**Note:** Rollback is NOT recommended as it reintroduces security vulnerabilities.

## Additional Security Measures

### Input Validation
- All file uploads are validated for type and size
- Excel parsing includes error handling
- Malformed files are rejected gracefully

### Access Control
- Only authenticated users can export/import
- Role-based permissions enforced
- Audit logging for sensitive operations

## References

- [jsPDF v4 Migration Guide](https://github.com/parallax/jsPDF/releases)
- [ExcelJS Documentation](https://github.com/exceljs/exceljs)
- [CVE GHSA-f8cm-6447-x5h2](https://github.com/advisories/GHSA-f8cm-6447-x5h2)
- [CVE GHSA-4r6h-8v6p-xvw6](https://github.com/advisories/GHSA-4r6h-8v6p-xvw6)
- [CVE GHSA-5pgg-2g8v-p4x9](https://github.com/advisories/GHSA-5pgg-2g8v-p4x9)

## Support

For issues or questions:
1. Check the ExcelJS utility documentation in `src/lib/utils/excel.ts`
2. Review updated component examples
3. Contact the development team

---

**Status:** ✅ All security vulnerabilities resolved  
**Last Updated:** January 11, 2026
